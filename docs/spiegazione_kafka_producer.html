<!DOCTYPE html><html><head>
      <title>spiegazione_kafka_producer</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\lange\.antigravity\extensions\shd101wyy.markdown-preview-enhanced-0.8.20-universal\crossnote\dependencies\katex\katex.min.css">
      
      
      <script type="text/javascript" src="file:///c:\Users\lange\.antigravity\extensions\shd101wyy.markdown-preview-enhanced-0.8.20-universal\crossnote\dependencies\mermaid\mermaid.min.js" charset="UTF-8"></script>
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="spiegazione-del-kafka-producer-e-integrazione-con-spark">Spiegazione del Kafka Producer e Integrazione con Spark </h1>
<p>Questo documento spiega in dettaglio il funzionamento del file <code>kafka_producer.py</code>, che implementa un <strong>producer Kafka</strong> per pubblicare eventi relativi ai film degli utenti, e come questi eventi vengono <strong>consumati da Spark Streaming</strong>.</p>
<blockquote>
<p>[!NOTE]<br>
Questo documento fa parte di una triade: <strong>Producer</strong> (backend) ‚Üí <strong>Kafka</strong> (broker) ‚Üí <strong>Consumer</strong> (Spark). Per una comprensione completa, leggi anche [spiegazione_main.md](file:///c:/Users/lange/Desktop/Esame-Fenza/docs/spiegazione_main.md).</p>
</blockquote>
<hr>
<h2 id="-panoramica-generale">üìã Panoramica Generale </h2>
<p>Il modulo gestisce la <strong>pubblicazione di eventi</strong> su un topic Kafka chiamato <code>user-movie-events</code>. Ogni volta che un utente aggiunge, modifica o elimina un film dalla propria lista, viene generato un evento che viene inviato a Kafka per essere successivamente elaborato (tipicamente da Apache Spark).</p>
<hr>
<h2 id="Ô∏è-struttura-del-codice">üèóÔ∏è Struttura del Codice </h2>
<h3 id="import-e-dipendenze">Import e Dipendenze </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-import">import</span> os
<span class="token keyword keyword-import">import</span> json
<span class="token keyword keyword-import">import</span> logging
<span class="token keyword keyword-import">import</span> pytz
<span class="token keyword keyword-from">from</span> datetime <span class="token keyword keyword-import">import</span> datetime
<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> Optional
<span class="token keyword keyword-from">from</span> kafka <span class="token keyword keyword-import">import</span> KafkaProducer
<span class="token keyword keyword-from">from</span> kafka<span class="token punctuation">.</span>errors <span class="token keyword keyword-import">import</span> KafkaError
</code></pre><table>
<thead>
<tr>
<th>Libreria</th>
<th>Scopo</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>os</code></td>
<td>Lettura variabili d'ambiente</td>
</tr>
<tr>
<td><code>json</code></td>
<td>Serializzazione dei messaggi in formato JSON</td>
</tr>
<tr>
<td><code>logging</code></td>
<td>Logging degli eventi e degli errori</td>
</tr>
<tr>
<td><code>pytz</code></td>
<td>Gestione del fuso orario (Europe/Rome)</td>
</tr>
<tr>
<td><code>datetime</code></td>
<td>Timestamp degli eventi</td>
</tr>
<tr>
<td><code>kafka</code></td>
<td>Client Kafka per Python</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="-classe-movieeventproducer">üé¨ Classe <code>MovieEventProducer</code> </h2>
<h3 id="attributi-di-classe">Attributi di Classe </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>TOPIC <span class="token operator">=</span> <span class="token string">"user-movie-events"</span>
</code></pre><ul>
<li><strong>TOPIC</strong>: Nome del topic Kafka su cui vengono pubblicati tutti gli eventi.</li>
</ul>
<h3>Costruttore <code>__init__</code> {#costruttore-<strong>init</strong> }</h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>bootstrap_servers <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"KAFKA_BOOTSTRAP_SERVERS"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>_producer<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>KafkaProducer<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    self<span class="token punctuation">.</span>_is_connected <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre><table>
<thead>
<tr>
<th>Attributo</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bootstrap_servers</code></td>
<td>Indirizzo del/dei broker Kafka (da variabile d'ambiente o default)</td>
</tr>
<tr>
<td><code>_producer</code></td>
<td>Istanza del KafkaProducer (inizializzata lazy)</td>
</tr>
<tr>
<td><code>_is_connected</code></td>
<td>Flag che indica se la connessione √® attiva</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="metodo-_get_producer---lazy-initialization">Metodo <code>_get_producer()</code> - Lazy Initialization </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">_get_producer</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span>KafkaProducer<span class="token punctuation">]</span><span class="token punctuation">:</span>
</code></pre><p>Questo metodo implementa il pattern <strong>Lazy Initialization</strong>: il producer Kafka viene creato solo quando serve per la prima volta.</p>
<h4 id="configurazione-del-producer">Configurazione del Producer: </h4>
<table>
<thead>
<tr>
<th>Parametro</th>
<th>Valore</th>
<th>Spiegazione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bootstrap_servers</code></td>
<td>Lista di broker</td>
<td>Server Kafka a cui connettersi</td>
</tr>
<tr>
<td><code>value_serializer</code></td>
<td>JSON encoder</td>
<td>Converte i dati in JSON e poi in bytes UTF-8</td>
</tr>
<tr>
<td><code>key_serializer</code></td>
<td>String encoder</td>
<td>Converte la chiave (user_id) in bytes</td>
</tr>
<tr>
<td><code>acks='all'</code></td>
<td>Tutti</td>
<td>Attende conferma da tutti i replica per garantire la consegna</td>
</tr>
<tr>
<td><code>retries=3</code></td>
<td>3 tentativi</td>
<td>Numero di retry in caso di errore</td>
</tr>
<tr>
<td><code>retry_backoff_ms=500</code></td>
<td>500ms</td>
<td>Tempo di attesa tra i retry</td>
</tr>
<tr>
<td><code>request_timeout_ms=10000</code></td>
<td>10 secondi</td>
<td>Timeout per le richieste</td>
</tr>
<tr>
<td><code>max_block_ms=10000</code></td>
<td>10 secondi</td>
<td>Tempo massimo di blocco se Kafka non risponde</td>
</tr>
</tbody>
</table>
<blockquote>
<p>[!IMPORTANT]<br>
Il parametro <code>acks='all'</code> garantisce che il messaggio sia stato replicato su tutti i broker prima di considerarlo "inviato". Questo aumenta l'affidabilit√† ma pu√≤ impattare leggermente le performance.</p>
</blockquote>
<hr>
<h3 id="metodo-send_movie_event---invio-singolo-evento">Metodo <code>send_movie_event()</code> - Invio Singolo Evento </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">send_movie_event</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> movie_data<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
</code></pre><p>Questo √® il metodo principale per inviare un <strong>singolo evento</strong> a Kafka.</p>
<h4 id="parametri">Parametri: </h4>
<table>
<thead>
<tr>
<th>Parametro</th>
<th>Tipo</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>event_type</code></td>
<td><code>str</code></td>
<td>Tipo di evento: <code>ADD</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>UPDATE_RATING</code></td>
</tr>
<tr>
<td><code>user_id</code></td>
<td><code>str</code></td>
<td>ID dell'utente che ha effettuato l'azione</td>
</tr>
<tr>
<td><code>movie_data</code></td>
<td><code>dict</code></td>
<td>Dati del film (nome, anno, rating, generi, ecc.)</td>
</tr>
</tbody>
</table>
<h4 id="struttura-dellevento">Struttura dell'Evento: </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>event <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"event_type"</span><span class="token punctuation">:</span> <span class="token string">"ADD"</span><span class="token punctuation">,</span>           <span class="token comment"># Tipo operazione</span>
    <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token string">"user123"</span><span class="token punctuation">,</span>          <span class="token comment"># ID utente</span>
    <span class="token string">"movie"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Inception"</span><span class="token punctuation">,</span>
        <span class="token string">"year"</span><span class="token punctuation">:</span> <span class="token number">2010</span><span class="token punctuation">,</span>
        <span class="token string">"rating"</span><span class="token punctuation">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
        <span class="token string">"imdb_id"</span><span class="token punctuation">:</span> <span class="token string">"tt1375666"</span><span class="token punctuation">,</span>
        <span class="token string">"genres"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"Sci-Fi"</span><span class="token punctuation">,</span> <span class="token string">"Action"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"duration"</span><span class="token punctuation">:</span> <span class="token number">148</span><span class="token punctuation">,</span>
        <span class="token string">"director"</span><span class="token punctuation">:</span> <span class="token string">"Christopher Nolan"</span><span class="token punctuation">,</span>
        <span class="token string">"actors"</span><span class="token punctuation">:</span> <span class="token string">"Leonardo DiCaprio, ..."</span><span class="token punctuation">,</span>
        <span class="token string">"date"</span><span class="token punctuation">:</span> <span class="token string">"2024-01-15"</span><span class="token punctuation">,</span>      <span class="token comment"># Data visione</span>
        <span class="token string">"old_rating"</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>        <span class="token comment"># Per UPDATE_RATING</span>
        <span class="token string">"new_rating"</span><span class="token punctuation">:</span> <span class="token boolean">None</span>         <span class="token comment"># Per UPDATE_RATING</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"timestamp"</span><span class="token punctuation">:</span> <span class="token string">"2024-01-15T10:30:00+01:00"</span>  <span class="token comment"># Timestamp ISO</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="partizionamento">Partizionamento: </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>producer<span class="token punctuation">.</span>send<span class="token punctuation">(</span>self<span class="token punctuation">.</span>TOPIC<span class="token punctuation">,</span> key<span class="token operator">=</span>user_id<span class="token punctuation">,</span> value<span class="token operator">=</span>event<span class="token punctuation">)</span>
</code></pre><blockquote>
<p>[!NOTE]<br>
L'uso di <code>user_id</code> come <strong>chiave</strong> garantisce che tutti gli eventi dello stesso utente finiscano nella stessa partizione Kafka. Questo assicura l'<strong>ordine cronologico</strong> degli eventi per utente.</p>
</blockquote>
<hr>
<h3 id="metodo-send_batch_event---invio-multiplo">Metodo <code>send_batch_event()</code> - Invio Multiplo </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">send_batch_event</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> event_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> user_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> movies<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
</code></pre><p>Permette di inviare <strong>pi√π eventi in batch</strong>, utile per operazioni come l'importazione massiva di film.</p>
<h4 id="caratteristiche">Caratteristiche: </h4>
<ol>
<li><strong>Itera</strong> su ogni film nella lista</li>
<li><strong>Crea un evento separato</strong> per ogni film (stesso formato di <code>send_movie_event</code>)</li>
<li><strong>Non attende conferma</strong> per ogni messaggio (fire-and-forget)</li>
<li>Esegue un <strong>flush finale</strong> per assicurarsi che tutti i messaggi siano inviati</li>
<li>Restituisce <code>True</code> se almeno un evento √® stato inviato con successo</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>producer<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Forza l'invio di tutti i messaggi in coda</span>
</code></pre><blockquote>
<p>[!TIP]<br>
Il batch non attende la conferma per ogni messaggio singolarmente, rendendo l'operazione pi√π veloce. La chiamata finale a <code>flush()</code> garantisce comunque che tutti i messaggi siano stati inviati prima di proseguire.</p>
</blockquote>
<hr>
<h3 id="metodi-ausiliari">Metodi Ausiliari </h3>
<h4 id="flush"><code>flush()</code> </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">flush</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Forza l'invio di tutti i messaggi in coda."""</span>
    <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>_producer<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_producer<span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><h4 id="close"><code>close()</code> </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">close</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Chiude il producer e rilascia le risorse."""</span>
    <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>_producer<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>_producer<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>_producer <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>_is_connected <span class="token operator">=</span> <span class="token boolean">False</span>
</code></pre><hr>
<h2 id="-pattern-singleton">üîÑ Pattern Singleton </h2>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>_producer_instance<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>MovieEventProducer<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token keyword keyword-def">def</span> <span class="token function">get_kafka_producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> MovieEventProducer<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Restituisce l'istanza singleton del producer."""</span>
    <span class="token keyword keyword-global">global</span> _producer_instance
    <span class="token keyword keyword-if">if</span> _producer_instance <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        _producer_instance <span class="token operator">=</span> MovieEventProducer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> _producer_instance
</code></pre><p>Il pattern <strong>Singleton</strong> garantisce che esista una sola istanza del producer in tutta l'applicazione. Questo √® importante perch√©:</p>
<ol>
<li><strong>Efficienza</strong>: Evita di creare connessioni multiple a Kafka</li>
<li><strong>Consistenza</strong>: Tutti i moduli usano la stessa connessione</li>
<li><strong>Gestione risorse</strong>: Facilita la chiusura pulita della connessione</li>
</ol>
<hr>
<h2 id="-flusso-degli-eventi">üìä Flusso degli Eventi </h2>
<div class="mermaid">sequenceDiagram
    participant U as Utente
    participant B as Backend (Flask)
    participant P as MovieEventProducer
    participant K as Kafka
    participant S as Spark Streaming

    U-&gt;&gt;B: Aggiunge film
    B-&gt;&gt;B: Salva in MongoDB
    B-&gt;&gt;P: send_movie_event("ADD", user_id, movie)
    P-&gt;&gt;K: Pubblica evento su "user-movie-events"
    K--&gt;&gt;P: Conferma (acks=all)
    K-&gt;&gt;S: Consuma eventi in streaming
    S-&gt;&gt;S: Ricalcola statistiche utente
</div><hr>
<h2 id="-tipi-di-eventi-supportati">üéØ Tipi di Eventi Supportati </h2>
<table>
<thead>
<tr>
<th>Evento</th>
<th>Quando viene generato</th>
<th>Dati rilevanti</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ADD</code></td>
<td>Utente aggiunge un film</td>
<td>Tutti i dati del film</td>
</tr>
<tr>
<td><code>UPDATE</code></td>
<td>Utente modifica un film</td>
<td>Dati aggiornati</td>
</tr>
<tr>
<td><code>DELETE</code></td>
<td>Utente rimuove un film</td>
<td>ID del film</td>
</tr>
<tr>
<td><code>UPDATE_RATING</code></td>
<td>Utente cambia solo il rating</td>
<td><code>old_rating</code> e <code>new_rating</code></td>
</tr>
<tr>
<td><code>BULK_IMPORT</code></td>
<td>Import massivo</td>
<td>Lista di film</td>
</tr>
<tr>
<td><code>RECALCULATE</code></td>
<td>Ricalcolo statistiche</td>
<td>Lista completa film utente</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="Ô∏è-gestione-errori">‚ö†Ô∏è Gestione Errori </h2>
<p>Il producer gestisce gli errori in modo <strong>graceful</strong>:</p>
<ol>
<li><strong>Kafka non disponibile</strong>: L'evento non viene pubblicato ma l'applicazione continua a funzionare</li>
<li><strong>Errore di invio</strong>: Viene loggato l'errore e il flag <code>_is_connected</code> viene resettato</li>
<li><strong>Retry automatici</strong>: Il producer √® configurato con 3 retry automatici</li>
</ol>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-except">except</span> KafkaError <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
    logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"‚ö†Ô∏è Kafka non disponibile: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">. Eventi non verranno pubblicati."</span></span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>_is_connected <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span>
</code></pre><blockquote>
<p>[!CAUTION]<br>
Se Kafka non √® disponibile, gli eventi vanno <strong>persi</strong>. In un sistema di produzione, si potrebbe implementare una coda locale di backup o un meccanismo di retry pi√π sofisticato.</p>
</blockquote>
<hr>
<h2 id="-esempio-di-utilizzo">üìù Esempio di Utilizzo </h2>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-from">from</span> kafka_producer <span class="token keyword keyword-import">import</span> get_kafka_producer

<span class="token comment"># Ottieni l'istanza singleton</span>
producer <span class="token operator">=</span> get_kafka_producer<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Invia un evento quando l'utente aggiunge un film</span>
movie_data <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"The Matrix"</span><span class="token punctuation">,</span>
    <span class="token string">"year"</span><span class="token punctuation">:</span> <span class="token number">1999</span><span class="token punctuation">,</span>
    <span class="token string">"rating"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string">"genres"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"Sci-Fi"</span><span class="token punctuation">,</span> <span class="token string">"Action"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"imdb_id"</span><span class="token punctuation">:</span> <span class="token string">"tt0133093"</span>
<span class="token punctuation">}</span>

success <span class="token operator">=</span> producer<span class="token punctuation">.</span>send_movie_event<span class="token punctuation">(</span><span class="token string">"ADD"</span><span class="token punctuation">,</span> <span class="token string">"user_123"</span><span class="token punctuation">,</span> movie_data<span class="token punctuation">)</span>

<span class="token keyword keyword-if">if</span> success<span class="token punctuation">:</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Evento pubblicato con successo!"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"Kafka non disponibile, evento non pubblicato"</span><span class="token punctuation">)</span>
</code></pre><hr>
<h2 id="-come-spark-consuma-gli-eventi-il-lato-consumer">üî• Come Spark Consuma gli Eventi (Il Lato Consumer) </h2>
<p>Una volta che il producer pubblica un evento su Kafka, <strong>Spark Streaming</strong> lo consuma e lo elabora. Questa sezione spiega esattamente cosa succede.</p>
<h3 id="architettura-v6-flat-affinities">Architettura V6: Flat Affinities </h3>
<p>L'architettura attuale (V6) usa una struttura <strong>piatta</strong> per le affinit√† utente, separando le metriche globali dalle affinit√† individuali:</p>
<div class="mermaid">graph TD
    subgraph Kafka
        T[Topic: user-movie-events]
    end
    
    subgraph Spark["Spark Streaming (spark_stats_processor.py)"]
        C[Consumer]
        P[process_partition_incremental]
        A[Aggregazione In-Memoria]
    end
    
    subgraph MongoDB
        US[(user_stats)]
        UA[(user_affinities)]
        GS[(global_stats)]
    end
    
    T --&gt; C
    C --&gt; P
    P --&gt; A
    A --&gt;|Bulk Write 1| US
    A --&gt;|Bulk Write 2| UA
    P --&gt;|Global Trends Stream| GS
</div><h3 id="schema-delle-collezioni-scritte-da-spark">Schema delle Collezioni Scritte da Spark </h3>
<h4 id="1-user_stats---metriche-globali">1. <code>user_stats</code> - Metriche Globali </h4>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code><span class="token punctuation">{</span>
    <span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token string">"pasquale.langellotti"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"total_watched"</span><span class="token operator">:</span> <span class="token number">847</span><span class="token punctuation">,</span>
    <span class="token string-property property">"sum_ratings"</span><span class="token operator">:</span> <span class="token number">3245</span><span class="token punctuation">,</span>
    <span class="token string-property property">"watch_time_minutes"</span><span class="token operator">:</span> <span class="token number">102450</span><span class="token punctuation">,</span>
    <span class="token string-property property">"rating_distribution"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">"1"</span><span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string-property property">"2"</span><span class="token operator">:</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token string-property property">"3"</span><span class="token operator">:</span> <span class="token number">156</span><span class="token punctuation">,</span> <span class="token string-property property">"4"</span><span class="token operator">:</span> <span class="token number">312</span><span class="token punctuation">,</span> <span class="token string-property property">"5"</span><span class="token operator">:</span> <span class="token number">311</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"monthly_counts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token string-property property">"2024"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"01"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string-property property">"02"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string-property property">"03"</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"2025"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"01"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string-property property">"02"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"stats_version"</span><span class="token operator">:</span> <span class="token string">"6.0_flat_affinities"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"updated_at"</span><span class="token operator">:</span> <span class="token string">"2026-01-22T12:00:00+01:00"</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="2-user_affinities---struttura-piatta">2. <code>user_affinities</code> - Struttura Piatta </h4>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code><span class="token comment">// Documento per ogni relazione utente-entit√†</span>
<span class="token punctuation">{</span>
    <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token string">"pasquale.langellotti_director_Christopher_Nolan"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token string">"pasquale.langellotti"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"director"</span><span class="token punctuation">,</span>        <span class="token comment">// o "actor" o "genre"</span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"Christopher Nolan"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"name_key"</span><span class="token operator">:</span> <span class="token string">"Christopher_Nolan"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"count"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                <span class="token comment">// Film visti con questo regista</span>
    <span class="token string-property property">"sum_voti"</span><span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>            <span class="token comment">// Somma dei rating dati</span>
    <span class="token string-property property">"updated_at"</span><span class="token operator">:</span> <span class="token string">"2026-01-22T12:00:00+01:00"</span>
<span class="token punctuation">}</span>
</code></pre><blockquote>
<p>[!IMPORTANT]<br>
La struttura piatta di <code>user_affinities</code> √® 10-100x pi√π veloce della precedente struttura nidificata. Ogni query pu√≤ filtrare per <code>type</code> e <code>user_id</code> usando gli indici MongoDB.</p>
</blockquote>
<hr>
<h3 id="come-spark-elabora-ogni-tipo-di-evento">Come Spark Elabora Ogni Tipo di Evento </h3>
<h4 id="evento-add---aggiunta-film">Evento <code>ADD</code> - Aggiunta Film </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Spark incrementa questi contatori:</span>
<span class="token punctuation">{</span>
    <span class="token string">"$inc"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"total_watched"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"sum_ratings"</span><span class="token punctuation">:</span> rating_value<span class="token punctuation">,</span>
        <span class="token string">"watch_time_minutes"</span><span class="token punctuation">:</span> duration<span class="token punctuation">,</span>
        <span class="token string">"rating_distribution.{rating}"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"monthly_counts.{year}.{month}"</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># Per ogni director/actor/genre, crea/aggiorna in user_affinities:</span>
<span class="token punctuation">{</span>
    <span class="token string">"$inc"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"count"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"sum_voti"</span><span class="token punctuation">:</span> rating_value<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="evento-delete---rimozione-film">Evento <code>DELETE</code> - Rimozione Film </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Spark DECREMENTA gli stessi contatori:</span>
<span class="token punctuation">{</span>
    <span class="token string">"$inc"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"total_watched"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"sum_ratings"</span><span class="token punctuation">:</span> <span class="token operator">-</span>rating_value<span class="token punctuation">,</span>
        <span class="token string">"watch_time_minutes"</span><span class="token punctuation">:</span> <span class="token operator">-</span>duration<span class="token punctuation">,</span>
        <span class="token string">"rating_distribution.{rating}"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"monthly_counts.{year}.{month}"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># Per ogni director/actor/genre:</span>
<span class="token punctuation">{</span>
    <span class="token string">"$inc"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"count"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"sum_voti"</span><span class="token punctuation">:</span> <span class="token operator">-</span>rating_value<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="evento-update_rating---modifica-solo-rating">Evento <code>UPDATE_RATING</code> - Modifica Solo Rating </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Spark modifica SOLO rating_distribution e sum_ratings:</span>
<span class="token punctuation">{</span>
    <span class="token string">"$inc"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"rating_distribution.{old_rating}"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># Decrementa vecchio</span>
        <span class="token string">"rating_distribution.{new_rating}"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>   <span class="token comment"># Incrementa nuovo</span>
        <span class="token string">"sum_ratings"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>new_rating <span class="token operator">-</span> old_rating<span class="token punctuation">)</span> <span class="token comment"># Delta</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment"># NOTA: total_watched e monthly_counts NON vengono toccati!</span>

<span class="token comment"># Per affinities, aggiorna solo sum_voti (non count):</span>
<span class="token punctuation">{</span>
    <span class="token string">"$inc"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"sum_voti"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>new_rating <span class="token operator">-</span> old_rating<span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><blockquote>
<p>[!TIP]<br>
La differenziazione tra <code>ADD</code> e <code>UPDATE_RATING</code> √® cruciale. Se un utente cambia il rating da 3 a 5, NON deve incrementare <code>total_watched</code> (il film era gi√† stato contato).</p>
</blockquote>
<hr>
<h3 id="flusso-di-elaborazione-in-spark">Flusso di Elaborazione in Spark </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">process_partition_incremental</span><span class="token punctuation">(</span>iterator<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Funzione eseguita in PARALLELO su ogni worker Spark.
    """</span>
    <span class="token comment"># 1. Raccoglie tutti i titoli per batch lookup catalogo</span>
    all_titles <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> row <span class="token keyword keyword-in">in</span> all_rows<span class="token punctuation">:</span>
        <span class="token keyword keyword-for">for</span> event <span class="token keyword keyword-in">in</span> row<span class="token punctuation">.</span>events<span class="token punctuation">:</span>
            all_titles<span class="token punctuation">.</span>add<span class="token punctuation">(</span>event<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
    
    <span class="token comment"># 2. BATCH LOOKUP catalogo (O(batch_size), non O(N_film))</span>
    catalog_docs <span class="token operator">=</span> db<span class="token punctuation">.</span>movies_catalog<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$in"</span><span class="token punctuation">:</span> all_titles<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    catalog_map <span class="token operator">=</span> <span class="token punctuation">{</span>d<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span><span class="token punctuation">:</span> d <span class="token keyword keyword-for">for</span> d <span class="token keyword keyword-in">in</span> catalog_docs<span class="token punctuation">}</span>
    
    <span class="token comment"># 3. Aggregazione IN-MEMORIA per ogni utente</span>
    user_stats_inc <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>       <span class="token comment"># {user_id: {campo: valore}}</span>
    user_affinities_inc <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># {affinity_id: {count, sum_voti}}</span>
    
    <span class="token keyword keyword-for">for</span> row <span class="token keyword keyword-in">in</span> all_rows<span class="token punctuation">:</span>
        <span class="token keyword keyword-for">for</span> event <span class="token keyword keyword-in">in</span> row<span class="token punctuation">.</span>events<span class="token punctuation">:</span>
            <span class="token comment"># Calcola delta in base al tipo evento</span>
            <span class="token keyword keyword-if">if</span> event<span class="token punctuation">.</span>event_type <span class="token operator">==</span> <span class="token string">"DELETE"</span><span class="token punctuation">:</span>
                delta <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
            <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                delta <span class="token operator">=</span> <span class="token number">1</span>
            
            <span class="token comment"># Accumula incrementi</span>
            user_stats_inc<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"total_watched"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> delta
            <span class="token comment"># ... altri campi</span>
    
    <span class="token comment"># 4. BULK WRITE su MongoDB (una sola operazione per partizione)</span>
    db<span class="token punctuation">.</span>user_stats<span class="token punctuation">.</span>bulk_write<span class="token punctuation">(</span>bulk_ops<span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>user_affinities<span class="token punctuation">.</span>bulk_write<span class="token punctuation">(</span>affinity_ops<span class="token punctuation">)</span>
</code></pre><hr>
<h3 id="tempistiche-di-elaborazione">Tempistiche di Elaborazione </h3>
<table>
<thead>
<tr>
<th>Componente</th>
<th>Trigger</th>
<th>Latenza Tipica</th>
</tr>
</thead>
<tbody>
<tr>
<td>Kafka ‚Üí Spark</td>
<td>Continuo</td>
<td>&lt; 1 secondo</td>
</tr>
<tr>
<td>Batch Processing</td>
<td>Ogni 5 secondi</td>
<td>5-10 secondi</td>
</tr>
<tr>
<td>Global Trends</td>
<td>Ogni 2 minuti</td>
<td>2-3 minuti</td>
</tr>
<tr>
<td>Visibilit√† Frontend</td>
<td>Dopo batch</td>
<td>~10-30 secondi</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="-file-correlati">üîó File Correlati </h2>
<table>
<thead>
<tr>
<th>File</th>
<th>Ruolo</th>
</tr>
</thead>
<tbody>
<tr>
<td>[kafka_producer.py](file:///c:/Users/lange/Desktop/Esame-Fenza/backend/kafka_producer.py)</td>
<td>Producer (questo file)</td>
</tr>
<tr>
<td>[spark_stats_processor.py](file:///c:/Users/lange/Desktop/Esame-Fenza/backend/spark_stats_processor.py)</td>
<td>Consumer Spark</td>
</tr>
<tr>
<td>[<a href="http://main.py">main.py</a>](file:///c:/Users/lange/Desktop/Esame-Fenza/backend/main.py)</td>
<td>API che usa il producer</td>
</tr>
</tbody>
</table>

      </div>
      
      
    
    
    <script type="module">
// TODO: If ZenUML gets integrated into mermaid in the future,
//      we can remove the following lines.


var MERMAID_CONFIG = ({"startOnLoad":false});
if (typeof MERMAID_CONFIG !== 'undefined') {
  MERMAID_CONFIG.startOnLoad = false
  MERMAID_CONFIG.cloneCssStyles = false
  MERMAID_CONFIG.theme = "default"
}

mermaid.initialize(MERMAID_CONFIG || {})
if (typeof(window['Reveal']) !== 'undefined') {
  function mermaidRevealHelper(event) {
    var currentSlide = event.currentSlide
    var diagrams = currentSlide.querySelectorAll('.mermaid')
    for (var i = 0; i < diagrams.length; i++) {
      var diagram = diagrams[i]
      if (!diagram.hasAttribute('data-processed')) {
        mermaid.init(null, diagram, ()=> {
          Reveal.slide(event.indexh, event.indexv)
        })
      }
    }
  }
  Reveal.addEventListener('slidetransitionend', mermaidRevealHelper)
  Reveal.addEventListener('ready', mermaidRevealHelper)
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
} else {
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
}
</script>
    
    
    
  
    </body></html>
<!DOCTYPE html><html><head>
      <title>documentazione_kafka_spark</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\lange\.antigravity\extensions\shd101wyy.markdown-preview-enhanced-0.8.20-universal\crossnote\dependencies\katex\katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="documentazione-kafka-producer-e-spark-stats-processor">Documentazione Kafka Producer e Spark Stats Processor </h1>
<h2 id="indice">Indice </h2>
<ol>
<li><a href="#kafka_producerpy---funzioni">kafka_producer.py - Funzioni</a></li>
<li><a href="#spark_stats_processorpy---funzioni">spark_stats_processor.py - Funzioni</a></li>
<li><a href="#schema-eventi-kafka">Schema Eventi Kafka</a></li>
<li><a href="#funzionamento-spark-creazione-user_stats-e-user_affinities">Funzionamento Spark: Creazione user_stats e user_affinities</a></li>
<li><a href="#global-stats-bootstrap-e-streaming">Global Stats: Bootstrap e Streaming</a></li>
</ol>
<hr>
<h2 id="kafka_producerpy---funzioni">kafka_producer.py - Funzioni </h2>
<h3 id="classe-movieeventproducer">Classe <code>MovieEventProducer</code> </h3>
<table>
<thead>
<tr>
<th>Funzione</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__init__()</code></td>
<td>Inizializza il producer con configurazione Kafka. Legge <code>KAFKA_BOOTSTRAP_SERVERS</code> da variabili d'ambiente (default: <code>localhost:9092</code>). Imposta <code>_producer = None</code> e <code>_is_connected = False</code>.</td>
</tr>
<tr>
<td><code>_get_producer()</code></td>
<td><strong>Lazy initialization</strong> del producer Kafka. Configura: serializzazione JSON (<code>value_serializer</code>), chiave come stringa UTF-8, <code>acks='all'</code> per delivery garantita, 3 retry con backoff 500ms, timeout 10s. Restituisce <code>None</code> se Kafka non è raggiungibile (graceful degradation).</td>
</tr>
<tr>
<td><code>send_movie_event(event_type, user_id, movie_data)</code></td>
<td>Pubblica un singolo evento su topic <code>user-movie-events</code>. Costruisce payload con: <code>event_type</code>, <code>user_id</code>, oggetto <code>movie</code> (name, year, rating, imdb_id, genres, duration, director, actors, date, old_rating, new_rating), <code>timestamp</code> (fuso orario Europe/Rome). Usa <code>user_id</code> come chiave di partizionamento. Attende conferma con timeout 5s. Restituisce <code>True</code>/<code>False</code>.</td>
</tr>
<tr>
<td><code>send_batch_event(event_type, user_id, movies)</code></td>
<td>Itera sulla lista <code>movies</code> e pubblica un evento per ciascuno nel <strong>formato identico</strong> a <code>send_movie_event()</code>. Usato per BULK_IMPORT o RECALCULATE. Esegue <code>flush()</code> finale per garantire consegna. Restituisce <code>True</code> se almeno un evento è stato inviato.</td>
</tr>
<tr>
<td><code>flush()</code></td>
<td>Forza l'invio immediato di tutti i messaggi bufferizzati al broker Kafka.</td>
</tr>
<tr>
<td><code>close()</code></td>
<td>Chiude il producer, rilascia risorse e resetta lo stato di connessione.</td>
</tr>
</tbody>
</table>
<h3 id="funzione-globale">Funzione Globale </h3>
<table>
<thead>
<tr>
<th>Funzione</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>get_kafka_producer()</code></td>
<td>Pattern <strong>Singleton</strong>: restituisce sempre la stessa istanza di <code>MovieEventProducer</code>. Evita connessioni multiple al broker.</td>
</tr>
</tbody>
</table>
<h3 id="configurazione-producer-kafka">Configurazione Producer Kafka </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>KafkaProducer<span class="token punctuation">(</span>
    bootstrap_servers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"localhost:9092"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    value_serializer<span class="token operator">=</span><span class="token keyword keyword-lambda">lambda</span> v<span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>v<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    key_serializer<span class="token operator">=</span><span class="token keyword keyword-lambda">lambda</span> k<span class="token punctuation">:</span> k<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> k <span class="token keyword keyword-else">else</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    acks<span class="token operator">=</span><span class="token string">'all'</span><span class="token punctuation">,</span>           <span class="token comment"># Attende conferma da tutti i replica</span>
    retries<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>            <span class="token comment"># Tentativi in caso di errore</span>
    retry_backoff_ms<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token comment"># Attesa tra retry</span>
    request_timeout_ms<span class="token operator">=</span><span class="token number">10000</span><span class="token punctuation">,</span>
    max_block_ms<span class="token operator">=</span><span class="token number">10000</span>    <span class="token comment"># Non bloccare troppo se Kafka è down</span>
<span class="token punctuation">)</span>
</code></pre><hr>
<h2 id="spark_stats_processorpy---funzioni">spark_stats_processor.py - Funzioni </h2>
<h3 id="funzioni-helper">Funzioni Helper </h3>
<table>
<thead>
<tr>
<th>Funzione</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>normalize_title(text)</code></td>
<td>Normalizza titolo: rimuove accenti via NFD decomposition, mappa caratteri speciali (ø→o, æ→ae, ß→ss, ñ→n, etc.), rimuove punteggiatura, converte in lowercase. Usato per matching tra titoli italiani/originali.</td>
</tr>
<tr>
<td><code>clean_key(name)</code></td>
<td><em>(Interna a <code>process_partition_incremental</code>)</em> Pulisce nomi per usarli come chiavi MongoDB: sostituisce <code>.</code>, <code>$</code>, spazi con <code>_</code>. Restituisce "Unknown" se vuoto.</td>
</tr>
<tr>
<td><code>merge_inc_fields(aggregated, new_fields)</code></td>
<td><em>(Interna)</em> Somma i valori di <code>new_fields</code> in <code>aggregated</code> per chiavi uguali. Usato per accumulare delta in memoria.</td>
</tr>
</tbody>
</table>
<h3 id="funzioni-spark-session">Funzioni Spark Session </h3>
<table>
<thead>
<tr>
<th>Funzione</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>create_spark_session()</code></td>
<td>Crea <code>SparkSession</code> con nome <code>CineMatch-StatsProcessor</code>. Configura pacchetti Maven: <code>spark-sql-kafka-0-10_2.12:3.4.1</code> e <code>mongo-spark-connector_2.12:10.2.0</code>. Imposta URI MongoDB per read/write su <code>cinematch_db</code>. Checkpoint in <code>/tmp/spark-checkpoints</code>.</td>
</tr>
</tbody>
</table>
<h3 id="funzioni-di-elaborazione-partizione">Funzioni di Elaborazione Partizione </h3>
<table>
<thead>
<tr>
<th>Funzione</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>process_partition_incremental(iterator)</code></td>
<td><strong>(V6 - ATTUALE)</strong> Elabora partizione in modo <strong>incrementale O(1)</strong>. Per ogni evento: (1) lookup batch catalogo, (2) accumula delta in dizionari <code>user_stats_inc</code> e <code>user_affinities_inc</code>, (3) esegue 2 <code>bulk_write()</code> atomiche. Gestisce ADD, DELETE, UPDATE_RATING. Scrive su <code>user_stats</code> e <code>user_affinities</code>.</td>
</tr>
<tr>
<td><code>process_partition_legacy(iterator)</code></td>
<td><strong>(V3 - LEGACY)</strong> Rilegge <strong>tutti i film</strong> dell'utente da <code>movies</code> collection, ricalcola stats complete con <code>compute_user_stats()</code>, scrive <code>$set</code> completo. Complessità O(N). Usato solo per migrazione/bootstrap.</td>
</tr>
<tr>
<td><code>process_partition(iterator)</code></td>
<td>Alias/wrapper che chiama <code>process_partition_incremental()</code>. Mantiene retrocompatibilità.</td>
</tr>
</tbody>
</table>
<h3 id="funzioni-di-batch-processing">Funzioni di Batch Processing </h3>
<table>
<thead>
<tr>
<th>Funzione</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>process_batch(batch_df, batch_id)</code></td>
<td>Callback per <code>foreachBatch</code> dello stream user_stats. Raggruppa DataFrame per <code>user_id</code>, colleziona eventi con <code>collect_list(struct(...))</code> includendo: event_type, name, year, rating, date, old_rating, new_rating. Chiama <code>foreachPartition(process_partition)</code> per elaborazione parallela.</td>
</tr>
</tbody>
</table>
<h3 id="funzioni-global-stats">Funzioni Global Stats </h3>
<table>
<thead>
<tr>
<th>Funzione</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>bootstrap_global_stats()</code></td>
<td><strong>Inizializzazione una tantum</strong> all'avvio. Legge tutti i film degli ultimi 30 giorni da <code>movies</code> collection. Calcola <code>movie_counts</code> (Counter), <code>genre_counts</code>, <code>top_movies</code> (Top 10), <code>trending_genres</code>. Salva <code>poster_cache</code> per evitare lookup ripetuti. Scrive su <code>global_stats</code> con <code>source: "bootstrap"</code>.</td>
</tr>
<tr>
<td><code>write_global_trends_to_mongo(batch_df, batch_id)</code></td>
<td>Callback streaming per global trends. Legge stato esistente da <code>global_stats</code>. Per ogni riga: se DELETE → decrementa conteggio, altrimenti incrementa. Aggiorna <code>poster_cache</code>. Ricalcola Top 10 e percentuali generi. Scrive con <code>source: "streaming_incremental"</code>.</td>
</tr>
<tr>
<td><code>start_global_trends_stream(spark, parsed_stream)</code></td>
<td>Configura Structured Streaming per trend globali. Aggiunge colonna <code>event_ts</code> da timestamp. Applica <strong>watermark 1 ora</strong> per gestire late data. Raggruppa per <code>(movie_name, event_type)</code>. Trigger ogni <strong>2 minuti</strong>. Output mode: <code>update</code>. Checkpoint: <code>/tmp/spark-checkpoints/today-trends</code>.</td>
</tr>
</tbody>
</table>
<h3 id="funzione-calcolo-statistiche-complete">Funzione Calcolo Statistiche Complete </h3>
<table>
<thead>
<tr>
<th>Funzione</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>compute_user_stats(movies, catalog_collection, prefetched_map)</code></td>
<td>Calcola statistiche <strong>complete</strong> da lista film. Restituisce dizionario con: <code>total_watched</code>, <code>avg_rating</code>, <code>rating_chart_data</code> (distribuzione 1-5), <code>top_rated_movies</code> (rating ≥4), <code>recent_movies</code> (ultimi 10), <code>year_data</code> (mensile per anno), <code>available_years</code>, <code>top_years</code>, <code>genre_data</code> (con colori e percentuali), <code>favorite_genre</code>, <code>watch_time_hours</code>, <code>avg_duration</code>, <code>best_rated_directors</code> (per soglie 1,2,3,5), <code>most_watched_directors</code>, <code>best_rated_actors</code>, <code>most_watched_actors</code>. Usato da versione legacy.</td>
</tr>
</tbody>
</table>
<h3 id="entry-point">Entry Point </h3>
<table>
<thead>
<tr>
<th>Funzione</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>main()</code></td>
<td>Entry point applicazione. (1) Chiama <code>bootstrap_global_stats()</code>, (2) crea SparkSession, (3) legge stream Kafka con <code>startingOffsets: latest</code>, (4) parse JSON con <code>event_schema</code>, (5) avvia stream <code>user_stats_stream</code> (trigger 5s), (6) avvia <code>global_trends_stream</code> (trigger 2min), (7) attende terminazione con <code>awaitAnyTermination()</code>.</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="schema-eventi-kafka">Schema Eventi Kafka </h2>
<h3 id="struttura-evento-json">Struttura Evento JSON </h3>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"event_type"</span><span class="token operator">:</span> <span class="token string">"ADD | UPDATE | DELETE | UPDATE_RATING | BULK_IMPORT | RECALCULATE"</span><span class="token punctuation">,</span>
  <span class="token property">"user_id"</span><span class="token operator">:</span> <span class="token string">"user123"</span><span class="token punctuation">,</span>
  <span class="token property">"movie"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Inception"</span><span class="token punctuation">,</span>
    <span class="token property">"year"</span><span class="token operator">:</span> <span class="token number">2010</span><span class="token punctuation">,</span>
    <span class="token property">"rating"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token property">"imdb_id"</span><span class="token operator">:</span> <span class="token string">"tt1375666"</span><span class="token punctuation">,</span>
    <span class="token property">"genres"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"Sci-Fi"</span><span class="token punctuation">,</span> <span class="token string">"Action"</span><span class="token punctuation">,</span> <span class="token string">"Thriller"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"duration"</span><span class="token operator">:</span> <span class="token number">148</span><span class="token punctuation">,</span>
    <span class="token property">"director"</span><span class="token operator">:</span> <span class="token string">"Christopher Nolan"</span><span class="token punctuation">,</span>
    <span class="token property">"actors"</span><span class="token operator">:</span> <span class="token string">"Leonardo DiCaprio, Joseph Gordon-Levitt, Ellen Page"</span><span class="token punctuation">,</span>
    <span class="token property">"date"</span><span class="token operator">:</span> <span class="token string">"2025-01-20"</span><span class="token punctuation">,</span>
    <span class="token property">"old_rating"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token property">"new_rating"</span><span class="token operator">:</span> <span class="token number">5</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2025-01-21T00:45:00+01:00"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="schema-spark-pyspark-structtype">Schema Spark (PySpark StructType) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>movie_schema <span class="token operator">=</span> StructType<span class="token punctuation">(</span><span class="token punctuation">[</span>
    StructField<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"year"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"rating"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"imdb_id"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"genres"</span><span class="token punctuation">,</span> ArrayType<span class="token punctuation">(</span>StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"duration"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"director"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"actors"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"old_rating"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"new_rating"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

event_schema <span class="token operator">=</span> StructType<span class="token punctuation">(</span><span class="token punctuation">[</span>
    StructField<span class="token punctuation">(</span><span class="token string">"event_type"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"movie"</span><span class="token punctuation">,</span> movie_schema<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><h3 id="tipi-di-evento">Tipi di Evento </h3>
<table>
<thead>
<tr>
<th>Event Type</th>
<th>Quando viene generato</th>
<th>Effetto su Stats</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ADD</code></td>
<td>Utente aggiunge film alla lista</td>
<td>Incrementa tutti i contatori</td>
</tr>
<tr>
<td><code>DELETE</code></td>
<td>Utente rimuove film dalla lista</td>
<td>Decrementa tutti i contatori</td>
</tr>
<tr>
<td><code>UPDATE</code></td>
<td>Utente modifica dettagli film (non rating)</td>
<td>Ricalcola se necessario</td>
</tr>
<tr>
<td><code>UPDATE_RATING</code></td>
<td>Utente cambia voto (es. 4→5)</td>
<td>Solo <code>sum_ratings</code> e <code>rating_distribution</code></td>
</tr>
<tr>
<td><code>BULK_IMPORT</code></td>
<td>Import massivo da CSV/file</td>
<td>Come ADD, per ogni film</td>
</tr>
<tr>
<td><code>RECALCULATE</code></td>
<td>Trigger ricalcolo forzato</td>
<td>Forza aggiornamento stats</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="funzionamento-spark-creazione-user_stats-e-user_affinities">Funzionamento Spark: Creazione user_stats e user_affinities </h2>
<h3 id="architettura-generale">Architettura Generale </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│  FastAPI        │      │  Kafka Topic    │      │  Spark          │
│  Backend        │─────▶│  user-movie-    │─────▶│  Streaming      │
│                 │      │  events         │      │                 │
└─────────────────┘      └─────────────────┘      └────────┬────────┘
                                                          │
                                                          ▼
                                               ┌─────────────────────┐
                                               │  MongoDB            │
                                               │  - user_stats       │
                                               │  - user_affinities  │
                                               │  - global_stats     │
                                               └─────────────────────┘
</code></pre><h3 id="flusso-di-elaborazione-dettagliato">Flusso di Elaborazione Dettagliato </h3>
<ol>
<li>
<p><strong>Evento Generato (Backend)</strong></p>
<ul>
<li>Utente esegue azione (add/delete/update film)</li>
<li><code>get_kafka_producer().send_movie_event()</code> pubblica su Kafka</li>
<li>Partizionamento per <code>user_id</code> garantisce ordine per utente</li>
</ul>
</li>
<li>
<p><strong>Spark Consuma da Kafka</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>kafka_stream <span class="token operator">=</span> spark<span class="token punctuation">.</span>readStream \
    <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"kafka"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"subscribe"</span><span class="token punctuation">,</span> <span class="token string">"user-movie-events"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"startingOffsets"</span><span class="token punctuation">,</span> <span class="token string">"latest"</span><span class="token punctuation">)</span>  <span class="token comment"># Solo nuovi eventi</span>
    <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"failOnDataLoss"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span>    <span class="token comment"># Continua anche se dati persi</span>
    <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></li>
<li>
<p><strong>Parsing JSON</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>parsed_stream <span class="token operator">=</span> kafka_stream \
    <span class="token punctuation">.</span>selectExpr<span class="token punctuation">(</span><span class="token string">"CAST(value AS STRING) as json_value"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>select<span class="token punctuation">(</span>from_json<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">"json_value"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event_schema<span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">"data.*"</span><span class="token punctuation">)</span>
</code></pre></li>
<li>
<p><strong>Micro-Batch Processing (ogni 5 secondi)</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>user_events_df <span class="token operator">=</span> batch_df<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>agg<span class="token punctuation">(</span>
    collect_list<span class="token punctuation">(</span>struct<span class="token punctuation">(</span>
        col<span class="token punctuation">(</span><span class="token string">"event_type"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        col<span class="token punctuation">(</span><span class="token string">"movie.name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        col<span class="token punctuation">(</span><span class="token string">"movie.rating"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"rating"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        col<span class="token punctuation">(</span><span class="token string">"movie.date"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        col<span class="token punctuation">(</span><span class="token string">"movie.old_rating"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"old_rating"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        col<span class="token punctuation">(</span><span class="token string">"movie.new_rating"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"new_rating"</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"events"</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
user_events_df<span class="token punctuation">.</span>foreachPartition<span class="token punctuation">(</span>process_partition<span class="token punctuation">)</span>
</code></pre></li>
</ol>
<hr>
<h3 id="logica-user_stats-collezione-mongodb">Logica user_stats (Collezione MongoDB) </h3>
<h4 id="schema-documento">Schema Documento </h4>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token function"><span class="token maybe-class-name">ObjectId</span></span><span class="token punctuation">(</span><span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token string">"user123"</span><span class="token punctuation">,</span>
  
  <span class="token comment">// Metriche globali (incrementali)</span>
  <span class="token string-property property">"total_watched"</span><span class="token operator">:</span> <span class="token number">42</span><span class="token punctuation">,</span>           <span class="token comment">// Totale film visti</span>
  <span class="token string-property property">"sum_ratings"</span><span class="token operator">:</span> <span class="token number">168</span><span class="token punctuation">,</span>            <span class="token comment">// Somma di tutti i voti (per calcolare media)</span>
  <span class="token string-property property">"watch_time_minutes"</span><span class="token operator">:</span> <span class="token number">5460</span><span class="token punctuation">,</span>    <span class="token comment">// Tempo totale di visione</span>
  
  <span class="token comment">// Distribuzione voti (1-5 stelle)</span>
  <span class="token string-property property">"rating_distribution"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"1"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string-property property">"2"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string-property property">"3"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string-property property">"4"</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token string-property property">"5"</span><span class="token operator">:</span> <span class="token number">8</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  
  <span class="token comment">// Film per mese/anno (struttura nidificata)</span>
  <span class="token string-property property">"monthly_counts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"2024"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">"01"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token string-property property">"02"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token string-property property">"03"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string-property property">"12"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"2025"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">"01"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  
  <span class="token comment">// Metadati</span>
  <span class="token string-property property">"updated_at"</span><span class="token operator">:</span> <span class="token string">"2025-01-21T00:45:00+01:00"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"stats_version"</span><span class="token operator">:</span> <span class="token string">"6.0_flat_affinities"</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="logica-incrementale-o1">Logica Incrementale O(1) </h4>
<p><strong>Principio</strong>: Non rileggiamo mai tutti i film dell'utente. Ogni evento produce solo un <code>$inc</code>.</p>
<table>
<thead>
<tr>
<th>Event Type</th>
<th>Campi $inc</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ADD</strong></td>
<td><code>total_watched: +1</code>, <code>sum_ratings: +rating</code>, <code>watch_time_minutes: +duration</code>, <code>rating_distribution.{rating}: +1</code>, <code>monthly_counts.{year}.{month}: +1</code></td>
</tr>
<tr>
<td><strong>DELETE</strong></td>
<td>Stessi campi con delta <code>-1</code></td>
</tr>
<tr>
<td><strong>UPDATE_RATING</strong></td>
<td>Solo <code>sum_ratings: (new-old)</code>, <code>rating_distribution.{old}: -1</code>, <code>rating_distribution.{new}: +1</code></td>
</tr>
</tbody>
</table>
<p><strong>Codice di aggregazione in memoria:</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Inizializza dizionario per utente</span>
<span class="token keyword keyword-if">if</span> user_id <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> user_stats_inc<span class="token punctuation">:</span>
    user_stats_inc<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># Per evento ADD/DELETE</span>
delta <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword keyword-if">if</span> <span class="token string">"DELETE"</span> <span class="token keyword keyword-in">in</span> event_type <span class="token keyword keyword-else">else</span> <span class="token number">1</span>
stats_inc <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"total_watched"</span><span class="token punctuation">:</span> delta<span class="token punctuation">,</span>
    <span class="token string">"sum_ratings"</span><span class="token punctuation">:</span> rating <span class="token operator">*</span> delta<span class="token punctuation">,</span>
    <span class="token string">"watch_time_minutes"</span><span class="token punctuation">:</span> duration <span class="token operator">*</span> delta<span class="token punctuation">,</span>
    <span class="token string-interpolation"><span class="token string">f"rating_distribution.</span><span class="token interpolation"><span class="token punctuation">{</span>rating<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">:</span> delta<span class="token punctuation">,</span>
    <span class="token string-interpolation"><span class="token string">f"monthly_counts.</span><span class="token interpolation"><span class="token punctuation">{</span>year<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>month<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">:</span> delta
<span class="token punctuation">}</span>
merge_inc_fields<span class="token punctuation">(</span>user_stats_inc<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">,</span> stats_inc<span class="token punctuation">)</span>

<span class="token comment"># Per UPDATE_RATING</span>
<span class="token keyword keyword-if">if</span> <span class="token string">"UPDATE_RATING"</span> <span class="token keyword keyword-in">in</span> event_type<span class="token punctuation">:</span>
    stats_inc <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string-interpolation"><span class="token string">f"rating_distribution.</span><span class="token interpolation"><span class="token punctuation">{</span>old_rating<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string-interpolation"><span class="token string">f"rating_distribution.</span><span class="token interpolation"><span class="token punctuation">{</span>new_rating<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">:</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string">"sum_ratings"</span><span class="token punctuation">:</span> new_rating <span class="token operator">-</span> old_rating
    <span class="token punctuation">}</span>
    merge_inc_fields<span class="token punctuation">(</span>user_stats_inc<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">,</span> stats_inc<span class="token punctuation">)</span>
</code></pre><p><strong>Bulk Write atomico:</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>bulk_ops <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword keyword-for">for</span> user_id<span class="token punctuation">,</span> aggregated_inc <span class="token keyword keyword-in">in</span> user_stats_inc<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    bulk_ops<span class="token punctuation">.</span>append<span class="token punctuation">(</span>UpdateOne<span class="token punctuation">(</span>
        <span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
            <span class="token string">"$inc"</span><span class="token punctuation">:</span> aggregated_inc<span class="token punctuation">,</span>
            <span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"updated_at"</span><span class="token punctuation">:</span> now_timestamp<span class="token punctuation">,</span>
                <span class="token string">"stats_version"</span><span class="token punctuation">:</span> <span class="token string">"6.0_flat_affinities"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        upsert<span class="token operator">=</span><span class="token boolean">True</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>user_stats<span class="token punctuation">.</span>bulk_write<span class="token punctuation">(</span>bulk_ops<span class="token punctuation">,</span> ordered<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre><hr>
<h3 id="logica-user_affinities-collezione-mongodb">Logica user_affinities (Collezione MongoDB) </h3>
<h4 id="schema-documento-struttura-piatta">Schema Documento (Struttura Piatta) </h4>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code><span class="token comment">// UN documento per ogni combinazione utente-tipo-nome</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token string">"user123_director_Christopher_Nolan"</span><span class="token punctuation">,</span>  <span class="token comment">// ID composto</span>
  <span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token string">"user123"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"director"</span><span class="token punctuation">,</span>           <span class="token comment">// "director" | "actor" | "genre"</span>
  <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"Christopher Nolan"</span><span class="token punctuation">,</span>  <span class="token comment">// Nome originale</span>
  <span class="token string-property property">"name_key"</span><span class="token operator">:</span> <span class="token string">"Christopher_Nolan"</span><span class="token punctuation">,</span>  <span class="token comment">// Nome normalizzato (chiave)</span>
  <span class="token string-property property">"count"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>                   <span class="token comment">// Numero di film visti</span>
  <span class="token string-property property">"sum_voti"</span><span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span>               <span class="token comment">// Somma dei voti (per media)</span>
  <span class="token string-property property">"updated_at"</span><span class="token operator">:</span> <span class="token string">"2025-01-21T00:45:00+01:00"</span>
<span class="token punctuation">}</span>
</code></pre><h4 id="generazione-id">Generazione ID </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">clean_key</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> name<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"$"</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"_"</span><span class="token punctuation">)</span>

<span class="token comment"># Esempi:</span>
<span class="token comment"># "Christopher Nolan" → "Christopher_Nolan"</span>
<span class="token comment"># "J.J. Abrams" → "J_J__Abrams"</span>
<span class="token comment"># "Robert Downey Jr." → "Robert_Downey_Jr_"</span>

affinity_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">type</span><span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{</span>clean_key<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
<span class="token comment"># "user123_director_Christopher_Nolan"</span>
</code></pre><h4 id="lookup-catalogo-per-enrichment">Lookup Catalogo per Enrichment </h4>
<p>Prima di processare gli eventi, Spark fa un <strong>batch lookup</strong> sul catalogo:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Raccogli tutti i titoli unici nel batch</span>
all_titles <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword keyword-for">for</span> row <span class="token keyword keyword-in">in</span> all_rows<span class="token punctuation">:</span>
    <span class="token keyword keyword-for">for</span> event <span class="token keyword keyword-in">in</span> row<span class="token punctuation">.</span>events<span class="token punctuation">:</span>
        all_titles<span class="token punctuation">.</span>add<span class="token punctuation">(</span>event<span class="token punctuation">.</span>name<span class="token punctuation">)</span>

<span class="token comment"># Query batch (O(batch_size), non O(N_user_movies))</span>
catalog_docs <span class="token operator">=</span> db<span class="token punctuation">.</span>movies_catalog<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string">"$or"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$in"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>all_titles<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"original_title"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$in"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>all_titles<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"normalized_title"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$in"</span><span class="token punctuation">:</span> normalized_titles<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"normalized_original_title"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$in"</span><span class="token punctuation">:</span> normalized_titles<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># Costruisci mappa title → catalog_info</span>
<span class="token keyword keyword-for">for</span> doc <span class="token keyword keyword-in">in</span> catalog_docs<span class="token punctuation">:</span>
    catalog_map<span class="token punctuation">[</span>doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> doc
    catalog_map<span class="token punctuation">[</span>doc<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'original_title'</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> doc
    <span class="token comment"># ... anche normalized variants</span>
</code></pre><h4 id="logica-incrementale-per-affinities">Logica Incrementale per Affinities </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Per ogni evento</span>
catalog_info <span class="token operator">=</span> catalog_map<span class="token punctuation">.</span>get<span class="token punctuation">(</span>movie_name<span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
director <span class="token operator">=</span> catalog_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"director"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
actors_str <span class="token operator">=</span> catalog_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"actors"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
genres <span class="token operator">=</span> catalog_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"genres"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

delta <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword keyword-if">if</span> <span class="token string">"DELETE"</span> <span class="token keyword keyword-in">in</span> event_type <span class="token keyword keyword-else">else</span> <span class="token number">1</span>
rating_delta <span class="token operator">=</span> rating <span class="token operator">*</span> delta

<span class="token comment"># DIRECTORS (max 2 per film)</span>
directors_list <span class="token operator">=</span> <span class="token punctuation">[</span>d<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> d <span class="token keyword keyword-in">in</span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r'[,|]'</span><span class="token punctuation">,</span> director<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword keyword-for">for</span> dir_name <span class="token keyword keyword-in">in</span> directors_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    affinity_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">_director_</span><span class="token interpolation"><span class="token punctuation">{</span>clean_key<span class="token punctuation">(</span>dir_name<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    <span class="token keyword keyword-if">if</span> affinity_id <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> user_affinities_inc<span class="token punctuation">:</span>
        user_affinities_inc<span class="token punctuation">[</span>affinity_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"director"</span><span class="token punctuation">,</span>
            <span class="token string">"name"</span><span class="token punctuation">:</span> dir_name<span class="token punctuation">,</span> <span class="token string">"name_key"</span><span class="token punctuation">:</span> clean_key<span class="token punctuation">(</span>dir_name<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"count"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"sum_voti"</span><span class="token punctuation">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
    user_affinities_inc<span class="token punctuation">[</span>affinity_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"count"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> delta
    user_affinities_inc<span class="token punctuation">[</span>affinity_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"sum_voti"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> rating_delta

<span class="token comment"># ACTORS (max 5 per film)</span>
actors_list <span class="token operator">=</span> <span class="token punctuation">[</span>a<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> a <span class="token keyword keyword-in">in</span> re<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">r'[,|]'</span><span class="token punctuation">,</span> actors_str<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword keyword-for">for</span> actor <span class="token keyword keyword-in">in</span> actors_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    affinity_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">_actor_</span><span class="token interpolation"><span class="token punctuation">{</span>clean_key<span class="token punctuation">(</span>actor<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    <span class="token comment"># ... stessa logica</span>

<span class="token comment"># GENRES (tutti)</span>
<span class="token keyword keyword-for">for</span> genre <span class="token keyword keyword-in">in</span> genres<span class="token punctuation">:</span>
    affinity_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">_genre_</span><span class="token interpolation"><span class="token punctuation">{</span>clean_key<span class="token punctuation">(</span>genre<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    user_affinities_inc<span class="token punctuation">[</span>affinity_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"count"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> delta
    <span class="token comment"># Nota: generi NON hanno sum_voti</span>
</code></pre><h4 id="gestione-update_rating-per-affinities">Gestione UPDATE_RATING per Affinities </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-if">if</span> <span class="token string">"UPDATE_RATING"</span> <span class="token keyword keyword-in">in</span> event_type<span class="token punctuation">:</span>
    rating_diff <span class="token operator">=</span> new_rating <span class="token operator">-</span> old_rating
    
    <span class="token comment"># Aggiorna SOLO sum_voti (non count, perché il film era già visto)</span>
    <span class="token keyword keyword-for">for</span> dir_name <span class="token keyword keyword-in">in</span> directors_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        affinity_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">_director_</span><span class="token interpolation"><span class="token punctuation">{</span>clean_key<span class="token punctuation">(</span>dir_name<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        user_affinities_inc<span class="token punctuation">[</span>affinity_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"sum_voti"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> rating_diff
    
    <span class="token keyword keyword-for">for</span> actor <span class="token keyword keyword-in">in</span> actors_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        affinity_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">_actor_</span><span class="token interpolation"><span class="token punctuation">{</span>clean_key<span class="token punctuation">(</span>actor<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        user_affinities_inc<span class="token punctuation">[</span>affinity_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"sum_voti"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> rating_diff
</code></pre><h4 id="bulk-write-affinities">Bulk Write Affinities </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>affinity_ops <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword keyword-for">for</span> affinity_id<span class="token punctuation">,</span> data <span class="token keyword keyword-in">in</span> user_affinities_inc<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-if">if</span> data<span class="token punctuation">[</span><span class="token string">"count"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token keyword keyword-or">or</span> data<span class="token punctuation">[</span><span class="token string">"sum_voti"</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        affinity_ops<span class="token punctuation">.</span>append<span class="token punctuation">(</span>UpdateOne<span class="token punctuation">(</span>
            <span class="token punctuation">{</span><span class="token string">"_id"</span><span class="token punctuation">:</span> affinity_id<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                <span class="token string">"$inc"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"count"</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">"count"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"sum_voti"</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">"sum_voti"</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"user_id"</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">"user_id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"name"</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"name_key"</span><span class="token punctuation">:</span> data<span class="token punctuation">[</span><span class="token string">"name_key"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> now_timestamp
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            upsert<span class="token operator">=</span><span class="token boolean">True</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>user_affinities<span class="token punctuation">.</span>bulk_write<span class="token punctuation">(</span>affinity_ops<span class="token punctuation">,</span> ordered<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre><h4 id="vantaggi-struttura-piatta-vs-nested">Vantaggi Struttura Piatta vs Nested </h4>
<table>
<thead>
<tr>
<th>Aspetto</th>
<th>Struttura Piatta</th>
<th>Struttura Nested</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Query Top N</strong></td>
<td><code>find({user_id, type}).sort({count:-1}).limit(10)</code></td>
<td>Richiede aggregation pipeline</td>
</tr>
<tr>
<td><strong>Dimensione doc</strong></td>
<td>~200 bytes</td>
<td>Può crescere a MB</td>
</tr>
<tr>
<td><strong>Limite 16MB</strong></td>
<td>Mai raggiunto</td>
<td>Rischio con molti attori</td>
</tr>
<tr>
<td><strong>Indici</strong></td>
<td><code>{user_id:1, type:1, count:-1}</code></td>
<td>Indici su array inefficienti</td>
</tr>
<tr>
<td><strong>Update atomico</strong></td>
<td><code>$inc</code> su singolo doc</td>
<td><code>$inc</code> su elemento array (lento)</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="global-stats-bootstrap-e-streaming">Global Stats: Bootstrap e Streaming </h2>
<h3 id="schema-global_stats">Schema global_stats </h3>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code><span class="token punctuation">{</span>
  <span class="token string-property property">"_id"</span><span class="token operator">:</span> <span class="token function"><span class="token maybe-class-name">ObjectId</span></span><span class="token punctuation">(</span><span class="token string">"..."</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"global_trends"</span><span class="token punctuation">,</span>
  
  <span class="token comment">// Top 10 film più visti (precalcolato)</span>
  <span class="token string-property property">"top_movies"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"Inception"</span><span class="token punctuation">,</span> <span class="token string-property property">"poster_path"</span><span class="token operator">:</span> <span class="token string">"https://..."</span><span class="token punctuation">,</span> <span class="token string-property property">"count"</span><span class="token operator">:</span> <span class="token number">156</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token string">"The Dark Knight"</span><span class="token punctuation">,</span> <span class="token string-property property">"poster_path"</span><span class="token operator">:</span> <span class="token string">"https://..."</span><span class="token punctuation">,</span> <span class="token string-property property">"count"</span><span class="token operator">:</span> <span class="token number">142</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ... altri 8</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  
  <span class="token comment">// Top 10 generi con percentuali</span>
  <span class="token string-property property">"trending_genres"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token string-property property">"genre"</span><span class="token operator">:</span> <span class="token string">"Drama"</span><span class="token punctuation">,</span> <span class="token string-property property">"count"</span><span class="token operator">:</span> <span class="token number">450</span><span class="token punctuation">,</span> <span class="token string-property property">"percentage"</span><span class="token operator">:</span> <span class="token number">22.5</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token string-property property">"genre"</span><span class="token operator">:</span> <span class="token string">"Action"</span><span class="token punctuation">,</span> <span class="token string-property property">"count"</span><span class="token operator">:</span> <span class="token number">380</span><span class="token punctuation">,</span> <span class="token string-property property">"percentage"</span><span class="token operator">:</span> <span class="token number">19.0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ... altri 8</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  
  <span class="token comment">// Conteggi raw per merge incrementale</span>
  <span class="token string-property property">"movie_counts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"Inception"</span><span class="token operator">:</span> <span class="token number">156</span><span class="token punctuation">,</span>
    <span class="token string-property property">"The Dark Knight"</span><span class="token operator">:</span> <span class="token number">142</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Interstellar"</span><span class="token operator">:</span> <span class="token number">98</span><span class="token punctuation">,</span>
    <span class="token comment">// ... tutti i film</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"genre_counts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"Drama"</span><span class="token operator">:</span> <span class="token number">450</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Action"</span><span class="token operator">:</span> <span class="token number">380</span><span class="token punctuation">,</span>
    <span class="token comment">// ... tutti i generi</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  
  <span class="token comment">// Cache poster per evitare lookup ripetuti</span>
  <span class="token string-property property">"poster_cache"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"Inception"</span><span class="token operator">:</span> <span class="token string">"https://image.tmdb.org/..."</span><span class="token punctuation">,</span>
    <span class="token string-property property">"The Dark Knight"</span><span class="token operator">:</span> <span class="token string">"https://image.tmdb.org/..."</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  
  <span class="token comment">// Metadati</span>
  <span class="token string-property property">"updated_at"</span><span class="token operator">:</span> <span class="token string">"2025-01-21T00:45:00+01:00"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"total_movies_analyzed"</span><span class="token operator">:</span> <span class="token number">2500</span><span class="token punctuation">,</span>
  <span class="token string-property property">"source"</span><span class="token operator">:</span> <span class="token string">"bootstrap"</span> <span class="token operator">|</span> <span class="token string">"streaming_incremental"</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="fase-1-bootstrap-una-tantum-allavvio">Fase 1: Bootstrap (Una Tantum all'Avvio) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">bootstrap_global_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Calcola data limite (ultimi 30 giorni)</span>
    thirty_days_ago <span class="token operator">=</span> today <span class="token operator">-</span> timedelta<span class="token punctuation">(</span>days<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. Leggi TUTTI i film recenti</span>
    all_recent_movies <span class="token operator">=</span> db<span class="token punctuation">.</span>movies<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"$or"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token string">"date"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$gte"</span><span class="token punctuation">:</span> thirty_days_ago<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token string">"added_at"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$gte"</span><span class="token punctuation">:</span> thirty_days_ago<span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3. Conta film e generi</span>
    movie_counts <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    genre_counts <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> movie <span class="token keyword keyword-in">in</span> all_recent_movies<span class="token punctuation">:</span>
        movie_counts<span class="token punctuation">[</span>movie<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword keyword-for">for</span> genre <span class="token keyword keyword-in">in</span> movie<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"genres"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            genre_counts<span class="token punctuation">[</span>genre<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    
    <span class="token comment"># 4. Batch lookup catalogo per poster</span>
    catalog_docs <span class="token operator">=</span> db<span class="token punctuation">.</span>movies_catalog<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$in"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>movie_counts<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    poster_cache <span class="token operator">=</span> <span class="token punctuation">{</span>d<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span><span class="token punctuation">:</span> d<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"poster_url"</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> d <span class="token keyword keyword-in">in</span> catalog_docs<span class="token punctuation">}</span>
    
    <span class="token comment"># 5. Formatta Top 10</span>
    top_movies <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span> t<span class="token punctuation">,</span> <span class="token string">"poster_path"</span><span class="token punctuation">:</span> poster_cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">:</span> c<span class="token punctuation">}</span>
        <span class="token keyword keyword-for">for</span> t<span class="token punctuation">,</span> c <span class="token keyword keyword-in">in</span> movie_counts<span class="token punctuation">.</span>most_common<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    
    <span class="token comment"># 6. Salva con conteggi raw per merge successivo</span>
    db<span class="token punctuation">.</span>global_stats<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span>
        <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"global_trends"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token string">"movie_counts"</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>movie_counts<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        upsert<span class="token operator">=</span><span class="token boolean">True</span>
    <span class="token punctuation">)</span>
</code></pre><h3 id="fase-2-streaming-incrementale-continuo">Fase 2: Streaming Incrementale (Continuo) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">write_global_trends_to_mongo</span><span class="token punctuation">(</span>batch_df<span class="token punctuation">,</span> batch_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Leggi stato esistente (da bootstrap o batch precedente)</span>
    existing <span class="token operator">=</span> db<span class="token punctuation">.</span>global_stats<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"global_trends"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    movie_counts <span class="token operator">=</span> Counter<span class="token punctuation">(</span>existing<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"movie_counts"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    genre_counts <span class="token operator">=</span> Counter<span class="token punctuation">(</span>existing<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"genre_counts"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    poster_cache <span class="token operator">=</span> existing<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"poster_cache"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. Per ogni riga nel batch</span>
    <span class="token keyword keyword-for">for</span> row <span class="token keyword keyword-in">in</span> batch_df<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        title <span class="token operator">=</span> row<span class="token punctuation">.</span>movie_name
        event_type <span class="token operator">=</span> row<span class="token punctuation">.</span>event_type
        delta <span class="token operator">=</span> row<span class="token punctuation">.</span>watch_count  <span class="token comment"># Già aggregato da Spark</span>
        
        <span class="token keyword keyword-if">if</span> <span class="token string">"DELETE"</span> <span class="token keyword keyword-in">in</span> event_type<span class="token punctuation">:</span>
            <span class="token comment"># Decrementa</span>
            movie_counts<span class="token punctuation">[</span>title<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> movie_counts<span class="token punctuation">[</span>title<span class="token punctuation">]</span> <span class="token operator">-</span> delta<span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> movie_counts<span class="token punctuation">[</span>title<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-del">del</span> movie_counts<span class="token punctuation">[</span>title<span class="token punctuation">]</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token comment"># Incrementa</span>
            movie_counts<span class="token punctuation">[</span>title<span class="token punctuation">]</span> <span class="token operator">+=</span> delta
        
        <span class="token comment"># Stessa logica per generi...</span>
    
    <span class="token comment"># 3. Ricalcola Top 10 (O(N log 10) con heapq)</span>
    top_movies <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span> t<span class="token punctuation">,</span> <span class="token string">"poster_path"</span><span class="token punctuation">:</span> poster_cache<span class="token punctuation">.</span>get<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">:</span> c<span class="token punctuation">}</span>
        <span class="token keyword keyword-for">for</span> t<span class="token punctuation">,</span> c <span class="token keyword keyword-in">in</span> movie_counts<span class="token punctuation">.</span>most_common<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    
    <span class="token comment"># 4. Salva stato aggiornato</span>
    db<span class="token punctuation">.</span>global_stats<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span>
        <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"global_trends"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"streaming_incremental"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
</code></pre><h3 id="configurazione-stream-global-trends">Configurazione Stream Global Trends </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">start_global_trends_stream</span><span class="token punctuation">(</span>spark<span class="token punctuation">,</span> parsed_stream<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Prepara eventi con timestamp</span>
    events_with_ts <span class="token operator">=</span> parsed_stream \
        <span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">"event_ts"</span><span class="token punctuation">,</span> to_timestamp<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
        <span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">"movie.name"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isNotNull<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
        <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">"movie.name"</span><span class="token punctuation">,</span> <span class="token string">"event_type"</span><span class="token punctuation">,</span> <span class="token string">"event_ts"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. Watermark per gestire late data</span>
    watermarked <span class="token operator">=</span> events_with_ts<span class="token punctuation">.</span>withWatermark<span class="token punctuation">(</span><span class="token string">"event_ts"</span><span class="token punctuation">,</span> <span class="token string">"1 hour"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3. Aggregazione per movie_name + event_type</span>
    aggregated <span class="token operator">=</span> watermarked \
        <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">"movie_name"</span><span class="token punctuation">,</span> <span class="token string">"event_type"</span><span class="token punctuation">)</span> \
        <span class="token punctuation">.</span>agg<span class="token punctuation">(</span>count<span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"watch_count"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 4. Avvia stream</span>
    aggregated<span class="token punctuation">.</span>writeStream \
        <span class="token punctuation">.</span>foreachBatch<span class="token punctuation">(</span>write_global_trends_to_mongo<span class="token punctuation">)</span> \
        <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span><span class="token string">"update"</span><span class="token punctuation">)</span> \
        <span class="token punctuation">.</span>trigger<span class="token punctuation">(</span>processingTime<span class="token operator">=</span><span class="token string">"2 minutes"</span><span class="token punctuation">)</span> \
        <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"checkpointLocation"</span><span class="token punctuation">,</span> <span class="token string">"/tmp/spark-checkpoints/today-trends"</span><span class="token punctuation">)</span> \
        <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><hr>
<h3 id="differenza-tra-user-stats-e-global-stats">Differenza tra User Stats e Global Stats </h3>
<table>
<thead>
<tr>
<th>Aspetto</th>
<th>User Stats</th>
<th>Global Stats</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Trigger</strong></td>
<td>5 secondi</td>
<td>2 minuti</td>
</tr>
<tr>
<td><strong>Scope</strong></td>
<td>Per singolo utente</td>
<td>Tutti gli utenti (community)</td>
</tr>
<tr>
<td><strong>Collezioni</strong></td>
<td><code>user_stats</code> + <code>user_affinities</code></td>
<td><code>global_stats</code></td>
</tr>
<tr>
<td><strong>Inizializzazione</strong></td>
<td>Incrementale da zero</td>
<td>Bootstrap ultimi 30 giorni</td>
</tr>
<tr>
<td><strong>Logica</strong></td>
<td>Sempre incrementale O(1)</td>
<td>Bootstrap O(N) + Streaming O(batch)</td>
</tr>
<tr>
<td><strong>Dati</strong></td>
<td>Metriche personali, affinities</td>
<td>Top 10 film, trending genres</td>
</tr>
<tr>
<td><strong>Watermark</strong></td>
<td>No</td>
<td>1 ora</td>
</tr>
<tr>
<td><strong>Stato</strong></td>
<td>Ogni utente ha proprio doc</td>
<td>Singolo documento globale</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="flusso-completo-esempio-add">Flusso Completo: Esempio ADD </h2>
<pre data-role="codeBlock" data-info="" class="language-text"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 1: Utente aggiunge "Inception" (rating 5) nel frontend                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 2: Backend chiama get_kafka_producer().send_movie_event("ADD", ...)     │
│                                                                              │
│ Evento Kafka:                                                                │
│ {                                                                            │
│   "event_type": "ADD",                                                       │
│   "user_id": "u1",                                                           │
│   "movie": {"name": "Inception", "rating": 5, "date": "2025-01-21", ...},    │
│   "timestamp": "2025-01-21T01:00:00+01:00"                                   │
│ }                                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 3: Spark consuma da Kafka (trigger 5s), raggruppa per user_id           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 4: process_partition_incremental() su worker                            │
│                                                                              │
│ 4a. Batch lookup catalogo:                                                   │
│     catalog_map["Inception"] = {                                             │
│       "director": "Christopher Nolan",                                       │
│       "actors": "Leonardo DiCaprio, Joseph Gordon-Levitt, ...",              │
│       "genres": ["Sci-Fi", "Action", "Thriller"],                            │
│       "duration": 148                                                        │
│     }                                                                        │
│                                                                              │
│ 4b. Aggrega in memoria:                                                      │
│     user_stats_inc["u1"] = {                                                 │
│       "total_watched": +1,                                                   │
│       "sum_ratings": +5,                                                     │
│       "watch_time_minutes": +148,                                            │
│       "rating_distribution.5": +1,                                           │
│       "monthly_counts.2025.01": +1                                           │
│     }                                                                        │
│                                                                              │
│     user_affinities_inc = {                                                  │
│       "u1_director_Christopher_Nolan": {count: +1, sum_voti: +5},            │
│       "u1_actor_Leonardo_DiCaprio": {count: +1, sum_voti: +5},               │
│       "u1_actor_Joseph_Gordon-Levitt": {count: +1, sum_voti: +5},            │
│       "u1_genre_Sci-Fi": {count: +1, sum_voti: 0},                           │
│       "u1_genre_Action": {count: +1, sum_voti: 0},                           │
│       "u1_genre_Thriller": {count: +1, sum_voti: 0}                          │
│     }                                                                        │
│                                                                              │
│ 4c. bulk_write() su user_stats                                               │
│ 4d. bulk_write() su user_affinities                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ STEP 5: (Parallelo ogni 2min) write_global_trends_to_mongo()                 │
│                                                                              │
│ movie_counts["Inception"] += 1                                               │
│ genre_counts["Sci-Fi"] += 1                                                  │
│ genre_counts["Action"] += 1                                                  │
│ genre_counts["Thriller"] += 1                                                │
│                                                                              │
│ Ricalcola top_movies e trending_genres                                       │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre><hr>
<h2 id="indici-mongodb-consigliati">Indici MongoDB Consigliati </h2>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code><span class="token comment">// user_stats</span>
db<span class="token punctuation">.</span><span class="token property-access">user_stats</span><span class="token punctuation">.</span><span class="token method function property-access">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// user_affinities</span>
db<span class="token punctuation">.</span><span class="token property-access">user_affinities</span><span class="token punctuation">.</span><span class="token method function property-access">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-property property">"count"</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token property-access">user_affinities</span><span class="token punctuation">.</span><span class="token method function property-access">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string-property property">"sum_voti"</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// global_stats</span>
db<span class="token punctuation">.</span><span class="token property-access">global_stats</span><span class="token punctuation">.</span><span class="token method function property-access">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// movies_catalog (per lookup)</span>
db<span class="token punctuation">.</span><span class="token property-access">movies_catalog</span><span class="token punctuation">.</span><span class="token method function property-access">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">"title"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token property-access">movies_catalog</span><span class="token punctuation">.</span><span class="token method function property-access">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">"original_title"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span><span class="token property-access">movies_catalog</span><span class="token punctuation">.</span><span class="token method function property-access">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token string-property property">"normalized_title"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
      </div>
      
      
    
    
    
    
    
    
  
    </body></html>
<!DOCTYPE html><html><head>
      <title>spiegazione_main</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:///c:\Users\lange\.antigravity\extensions\shd101wyy.markdown-preview-enhanced-0.8.20-universal\crossnote\dependencies\katex\katex.min.css">
      
      
      <script type="text/javascript" src="file:///c:\Users\lange\.antigravity\extensions\shd101wyy.markdown-preview-enhanced-0.8.20-universal\crossnote\dependencies\mermaid\mermaid.min.js" charset="UTF-8"></script>
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="spiegazione-completa-di-mainpy">Spiegazione Completa di <code>main.py</code> </h1>
<p>Questo documento fornisce una spiegazione <strong>accurata e completa</strong> del file <code>main.py</code>, il cuore del backend di <strong>CineMatch</strong>. Ogni sezione viene analizzata in dettaglio, incluse le integrazioni con Kafka e il flusso degli eventi.</p>
<hr>
<h2 id="-glossario-dei-termini-tecnici">üìö Glossario dei Termini Tecnici </h2>
<p>Prima di iniziare, ecco un glossario completo dei termini tecnici usati nel codice:</p>
<table>
<thead>
<tr>
<th>Termine</th>
<th>Spiegazione</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>FastAPI</strong></td>
<td>Framework Python moderno per creare API REST ad alte prestazioni. Simile a Flask ma con supporto nativo per async/await e validazione automatica dei dati</td>
</tr>
<tr>
<td><strong>Endpoint</strong></td>
<td>Un URL specifico dell'API che risponde a richieste HTTP (es. <code>/login</code>, <code>/movies</code>). √à il "punto di accesso" a una funzionalit√†</td>
</tr>
<tr>
<td><strong>CORS</strong></td>
<td>Cross-Origin Resource Sharing. Meccanismo di sicurezza che permette al frontend (su porta 5173) di comunicare col backend (su porta 8000)</td>
</tr>
<tr>
<td><strong>Middleware</strong></td>
<td>Codice che si esegue PRIMA o DOPO ogni richiesta HTTP. Usato qui per CORS e logging</td>
</tr>
<tr>
<td><strong>MongoDB</strong></td>
<td>Database NoSQL document-oriented. Invece di tabelle usa "collezioni" di documenti JSON</td>
</tr>
<tr>
<td><strong>Collection</strong></td>
<td>Equivalente di una "tabella" in MongoDB. Contiene documenti (record)</td>
</tr>
<tr>
<td><strong>Document</strong></td>
<td>Equivalente di una "riga" in database SQL. √à un oggetto JSON con campi e valori</td>
</tr>
<tr>
<td><strong>ObjectId</strong></td>
<td>Identificatore unico generato automaticamente da MongoDB per ogni documento (simile a UUID)</td>
</tr>
<tr>
<td><strong>Pydantic</strong></td>
<td>Libreria per validazione dati. I modelli (come <code>UserAuth</code>) definiscono la struttura dei dati in ingresso</td>
</tr>
<tr>
<td><strong>BaseModel</strong></td>
<td>Classe base di Pydantic da cui ereditano tutti i modelli dati</td>
</tr>
<tr>
<td><strong>Depends</strong></td>
<td>Meccanismo FastAPI per dependency injection. Esegue funzioni prima dell'endpoint (es. autenticazione)</td>
</tr>
<tr>
<td><strong>HTTPException</strong></td>
<td>Modo standard per restituire errori HTTP (es. 404 Not Found, 401 Unauthorized)</td>
</tr>
<tr>
<td><strong>BackgroundTasks</strong></td>
<td>Sistema FastAPI per eseguire operazioni in background senza bloccare la risposta</td>
</tr>
<tr>
<td><strong>Scheduler</strong></td>
<td>Componente che esegue task automaticamente a orari prestabiliti (cron jobs)</td>
</tr>
<tr>
<td><strong>APScheduler</strong></td>
<td>Libreria Python per scheduling. <code>BackgroundScheduler</code> esegue job in thread separati</td>
</tr>
<tr>
<td><strong>Kafka</strong></td>
<td>Sistema di messaggistica distribuito. Permette comunicazione asincrona tra servizi</td>
</tr>
<tr>
<td><strong>Producer</strong></td>
<td>Componente che INVIA messaggi a Kafka (in questo caso, il backend)</td>
</tr>
<tr>
<td><strong>Consumer</strong></td>
<td>Componente che RICEVE messaggi da Kafka (in questo caso, Spark)</td>
</tr>
<tr>
<td><strong>Topic</strong></td>
<td>"Canale" Kafka su cui viaggiano i messaggi. Qui: <code>user-movie-events</code></td>
</tr>
<tr>
<td><strong>Event</strong></td>
<td>Messaggio pubblicato su Kafka che descrive un'azione (ADD, DELETE, UPDATE_RATING, etc.)</td>
</tr>
<tr>
<td><strong>Spark</strong></td>
<td>Framework per elaborazione dati distribuiti. Qui usato per calcolare statistiche utente</td>
</tr>
<tr>
<td><strong>Lazy Loading</strong></td>
<td>Pattern che ritarda l'inizializzazione di risorse fino a quando non servono</td>
</tr>
<tr>
<td><strong>Singleton</strong></td>
<td>Pattern che garantisce una sola istanza di una classe nell'intera applicazione</td>
</tr>
<tr>
<td><strong>TMDB</strong></td>
<td>The Movie Database. API esterna per ottenere metadati film (poster, cast, trama)</td>
</tr>
<tr>
<td><strong>Elasticsearch</strong></td>
<td>Motore di ricerca full-text. Usato per ricerche avanzate nel catalogo film</td>
</tr>
<tr>
<td><strong>Aggregation Pipeline</strong></td>
<td>Query MongoDB avanzate che trasformano documenti in pi√π step (come SQL con GROUP BY)</td>
</tr>
<tr>
<td><strong>Upsert</strong></td>
<td>Operazione che fa UPDATE se il documento esiste, INSERT se non esiste</td>
</tr>
<tr>
<td><strong>Cron</strong></td>
<td>Formato per specificare orari di esecuzione schedulata (es. "ogni giorno alle 01:00")</td>
</tr>
<tr>
<td><strong>JWT</strong></td>
<td>JSON Web Token. Standard per autenticazione stateless. Il token contiene info utente cifrate</td>
</tr>
<tr>
<td><strong>Hash</strong></td>
<td>Trasformazione irreversibile di una password in stringa sicura (non decifrabile)</td>
</tr>
<tr>
<td><strong>Normalization</strong></td>
<td>Processo di standardizzazione del testo (rimozione accenti, lowercase, ecc.) per matching</td>
</tr>
<tr>
<td><strong>Async/Await</strong></td>
<td>Paradigma Python per operazioni asincrone non-bloccanti</td>
</tr>
<tr>
<td><strong>Thread</strong></td>
<td>Unit√† di esecuzione parallela. Pi√π thread possono eseguire codice contemporaneamente</td>
</tr>
<tr>
<td><strong>Threadpool</strong></td>
<td>Pool di thread riutilizzabili per eseguire operazioni bloccanti senza bloccare l'event loop</td>
</tr>
<tr>
<td><strong>Embedding</strong></td>
<td>Rappresentazione numerica (vettore) di testo/film usata per raccomandazioni ML</td>
</tr>
<tr>
<td><strong>FAISS</strong></td>
<td>Libreria Facebook per ricerca di similarit√† su vettori (usata per recommendations)</td>
</tr>
<tr>
<td><strong>Ollama</strong></td>
<td>Runtime locale per modelli LLM. Usato qui per generare domande quiz</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="Ô∏è-struttura-del-file">üèóÔ∏è Struttura del File </h2>
<p>Il file <code>main.py</code> √® organizzato in sezioni logiche:</p>
<pre data-role="codeBlock" data-info="" class="language-text"><code>main.py (~3000 righe)
‚îÇ
‚îú‚îÄ‚îÄ üì¶ Import e Configurazione (1-70)
‚îú‚îÄ‚îÄ üöÄ Startup Event e Scheduler (170-412)
‚îú‚îÄ‚îÄ üîê Auth Endpoints (420-600)
‚îú‚îÄ‚îÄ üé¨ Cinema Endpoints (610-1030)
‚îú‚îÄ‚îÄ üìä Data &amp; Stats Endpoints (1030-1600)
‚îú‚îÄ‚îÄ üéØ Movies Endpoints (1600-2450)
‚îú‚îÄ‚îÄ üí¨ Sentiment &amp; Activity (2450-2510)
‚îú‚îÄ‚îÄ üìö Catalog Endpoints (2510-2770)
‚îú‚îÄ‚îÄ üîç Elasticsearch Search (2630-2730)
‚îú‚îÄ‚îÄ üìà Admin Stats (2770-2860)
‚îî‚îÄ‚îÄ üß† Quiz AI Endpoints (2860-3051)
</code></pre><hr>
<h2 id="1Ô∏è‚É£-import-e-configurazione-linee-1-70">1Ô∏è‚É£ Import e Configurazione (Linee 1-70) </h2>
<h3 id="dipendenze-principali">Dipendenze Principali </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-from">from</span> fastapi <span class="token keyword keyword-import">import</span> FastAPI<span class="token punctuation">,</span> UploadFile<span class="token punctuation">,</span> File<span class="token punctuation">,</span> Depends<span class="token punctuation">,</span> HTTPException<span class="token punctuation">,</span> status<span class="token punctuation">,</span> BackgroundTasks
<span class="token keyword keyword-from">from</span> fastapi<span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>cors <span class="token keyword keyword-import">import</span> CORSMiddleware
<span class="token keyword keyword-from">from</span> pymongo <span class="token keyword keyword-import">import</span> MongoClient
<span class="token keyword keyword-from">from</span> kafka_producer <span class="token keyword keyword-import">import</span> get_kafka_producer
</code></pre><table>
<thead>
<tr>
<th>Import</th>
<th>Ruolo</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FastAPI</code></td>
<td>Framework web principale</td>
</tr>
<tr>
<td><code>CORSMiddleware</code></td>
<td>Permette chiamate cross-origin dal frontend</td>
</tr>
<tr>
<td><code>MongoClient</code></td>
<td>Driver per connettersi a MongoDB</td>
</tr>
<tr>
<td><code>get_kafka_producer</code></td>
<td>Funzione per ottenere il producer Kafka singleton</td>
</tr>
</tbody>
</table>
<h3 id="configurazione-app">Configurazione App </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span>
    title<span class="token operator">=</span><span class="token string">"CineMatch API"</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"Sistema di raccomandazione film personalizzato"</span><span class="token punctuation">,</span>
    version<span class="token operator">=</span><span class="token string">"1.0.0"</span>
<span class="token punctuation">)</span>
</code></pre><h3 id="cors-configuration">CORS Configuration </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>app<span class="token punctuation">.</span>add_middleware<span class="token punctuation">(</span>
    CORSMiddleware<span class="token punctuation">,</span>
    allow_origins<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"http://localhost:5173"</span><span class="token punctuation">,</span> <span class="token string">"http://127.0.0.1:5173"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_credentials<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    allow_methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    allow_headers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"*"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre><blockquote>
<p>[!NOTE]<br>
CORS √® necessario perch√© il frontend (React su porta 5173) e il backend (FastAPI su porta 8000) sono su origini diverse. Senza CORS, il browser bloccherebbe le richieste.</p>
</blockquote>
<h3 id="connessione-database">Connessione Database </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>MONGO_URL <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"MONGODB_URL"</span><span class="token punctuation">,</span> <span class="token string">"mongodb://localhost:27017"</span><span class="token punctuation">)</span>
client <span class="token operator">=</span> MongoClient<span class="token punctuation">(</span>MONGO_URL<span class="token punctuation">)</span>
db <span class="token operator">=</span> client<span class="token punctuation">.</span>cinematch_db

<span class="token comment"># Collections</span>
users_collection <span class="token operator">=</span> db<span class="token punctuation">.</span>users
movies_collection <span class="token operator">=</span> db<span class="token punctuation">.</span>movies
movies_catalog <span class="token operator">=</span> db<span class="token punctuation">.</span>movies_catalog
stats_collection <span class="token operator">=</span> db<span class="token punctuation">.</span>user_stats
</code></pre><hr>
<h2 id="2Ô∏è‚É£-startup-event-linee-170-412">2Ô∏è‚É£ Startup Event (Linee 170-412) </h2>
<h3 id="cosa-succede-allavvio-dellapplicazione">Cosa Succede all'Avvio dell'Applicazione </h3>
<p>L'evento <code>@app.on_event("startup")</code> viene eseguito <strong>una sola volta</strong> quando il server si avvia.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>on_event</span><span class="token punctuation">(</span><span class="token string">"startup"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">startup_event</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</code></pre><h3 id="21-creazione-indici-mongodb">2.1 Creazione Indici MongoDB </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>users_collection<span class="token punctuation">.</span>create_index<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
users_collection<span class="token punctuation">.</span>create_index<span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
movies_collection<span class="token punctuation">.</span>create_index<span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">)</span>
stats_collection<span class="token punctuation">.</span>create_index<span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
movies_catalog<span class="token punctuation">.</span>create_index<span class="token punctuation">(</span><span class="token string">"normalized_title"</span><span class="token punctuation">)</span>
</code></pre><blockquote>
<p>[!IMPORTANT]<br>
Gli <strong>indici</strong> sono fondamentali per le performance. Senza indici, ogni query richiederebbe una scansione completa della collection.</p>
</blockquote>
<h3 id="22-creazione-utente-di-default">2.2 Creazione Utente di Default </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> default_user<span class="token punctuation">:</span>
    users_collection<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"pasquale.langellotti"</span><span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">:</span> get_password_hash<span class="token punctuation">(</span><span class="token string">"Pasquale19!"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><h3 id="23-scheduler-per-task-automatici">2.3 Scheduler per Task Automatici </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>scheduler <span class="token operator">=</span> BackgroundScheduler<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><table>
<thead>
<tr>
<th>Job</th>
<th>Orario</th>
<th>Funzione</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>movie_updater</code></td>
<td>01:00</td>
<td>Aggiorna film nuovi da TMDB</td>
</tr>
<tr>
<td><code>cinema_pipeline</code></td>
<td>00:00</td>
<td>Scraping programmazione cinema</td>
</tr>
<tr>
<td><code>embedding_update</code></td>
<td>00:30</td>
<td>Aggiorna embeddings per ML</td>
</tr>
<tr>
<td><code>quiz_generation</code></td>
<td>02:50</td>
<td>Genera domande quiz con AI</td>
</tr>
</tbody>
</table>
<h3 id="24-caricamento-csv-iniziale">2.4 Caricamento CSV Iniziale </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>csv_path <span class="token operator">=</span> <span class="token string">"/data/ratings.csv"</span>
<span class="token keyword keyword-if">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>csv_path<span class="token punctuation">)</span> <span class="token keyword keyword-and">and</span> <span class="token punctuation">(</span><span class="token keyword keyword-not">not</span> existing_stats <span class="token keyword keyword-or">or</span> <span class="token keyword keyword-not">not</span> has_data<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Carica film da CSV</span>
    movies_collection<span class="token punctuation">.</span>insert_many<span class="token punctuation">(</span>movies<span class="token punctuation">)</span>
    
    <span class="token comment"># RESET STATISTICHE</span>
    stats_collection<span class="token punctuation">.</span>delete_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Pubblica su Kafka per Spark</span>
    kafka_producer <span class="token operator">=</span> get_kafka_producer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    kafka_producer<span class="token punctuation">.</span>send_batch_event<span class="token punctuation">(</span><span class="token string">"BULK_IMPORT"</span><span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> movies<span class="token punctuation">)</span>
</code></pre><blockquote>
<p>[!CAUTION]<br>
Il <strong>reset delle statistiche</strong> prima del BULK_IMPORT √® CRITICO. Senza reset, Spark sommerebbe i nuovi dati a quelli vecchi, causando conteggi doppi.</p>
</blockquote>
<hr>
<h2 id="3Ô∏è‚É£-flusso-kafka-come-funziona-lintegrazione">3Ô∏è‚É£ Flusso Kafka: Come Funziona l'Integrazione </h2>
<p>Questa √® la parte pi√π importante da capire. Vediamo come ogni operazione sui film genera eventi Kafka.</p>
<h3 id="diagramma-del-flusso-completo">Diagramma del Flusso Completo </h3>
<div class="mermaid">flowchart TD
    subgraph Frontend
        A[Utente]
    end
    
    subgraph Backend ["Backend (main.py)"]
        B[API Endpoint]
        C[MongoDB]
        D[Kafka Producer]
    end
    
    subgraph Kafka
        E[Topic: user-movie-events]
    end
    
    subgraph Spark ["Spark Streaming"]
        F[Consumer]
        G[Calcolo Statistiche]
    end
    
    A --&gt;|1. Aggiunge film| B
    B --&gt;|2. Salva in DB| C
    B --&gt;|3. Pubblica evento| D
    D --&gt;|4. Invia messaggio| E
    E --&gt;|5. Consuma| F
    F --&gt;|6. Elabora| G
    G --&gt;|7. Salva stats| C
</div><h3 id="tipi-di-eventi-e-quando-vengono-generati">Tipi di Eventi e Quando Vengono Generati </h3>
<table>
<thead>
<tr>
<th>Evento</th>
<th>Quando</th>
<th>Operazione MongoDB prima</th>
<th>Cosa fa Spark</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ADD</code></td>
<td>Nuovo film aggiunto</td>
<td><code>insert_one()</code></td>
<td>Incrementa contatori (total_watched, genre_counts, rating_distribution, monthly_counts)</td>
</tr>
<tr>
<td><code>DELETE</code></td>
<td>Film rimosso</td>
<td><code>delete_one()</code></td>
<td>Decrementa contatori</td>
</tr>
<tr>
<td><code>UPDATE_RATING</code></td>
<td>Cambia solo rating</td>
<td><code>update_one()</code></td>
<td>Aggiorna sum_ratings e rating_distribution (old_rating ‚Üí new_rating)</td>
</tr>
<tr>
<td><code>BULK_IMPORT</code></td>
<td>Upload CSV</td>
<td><code>insert_many()</code></td>
<td>Ricalcola tutto da zero</td>
</tr>
<tr>
<td><code>RECALCULATE</code></td>
<td>Richiesta manuale</td>
<td>Nessuna</td>
<td>Ricalcola tutto da zero</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="4Ô∏è‚É£-endpoint-per-endpoint-dove-kafka-viene-usato">4Ô∏è‚É£ Endpoint per Endpoint: Dove Kafka Viene Usato </h2>
<h3 id="41-post-movies---aggiunta-film-singolo-linea-1664">4.1 POST <code>/movies</code> - Aggiunta Film Singolo (Linea 1664) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/movies"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">add_movie</span><span class="token punctuation">(</span>movie<span class="token punctuation">:</span> MovieCreate<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Salva in MongoDB</span>
    result <span class="token operator">=</span> movies_collection<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>entry<span class="token punctuation">)</span>
    
    <span class="token comment"># 2. Aggiorna utente</span>
    users_collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3. Pubblica evento Kafka</span>
    kafka_producer <span class="token operator">=</span> get_kafka_producer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    kafka_producer<span class="token punctuation">.</span>send_movie_event<span class="token punctuation">(</span><span class="token string">"ADD"</span><span class="token punctuation">,</span> current_user_id<span class="token punctuation">,</span> entry<span class="token punctuation">)</span>
</code></pre><p><strong>Flusso:</strong></p>
<ol>
<li>Il film viene salvato nella collection <code>movies</code></li>
<li>Il flag <code>has_data</code> dell'utente viene settato a <code>True</code></li>
<li>Un evento <code>ADD</code> viene pubblicato su Kafka</li>
<li>Spark riceve l'evento e incrementa le statistiche</li>
</ol>
<h3 id="42-post-user-moviesadd---aggiunta-da-catalogo-linea-2175">4.2 POST <code>/user-movies/add</code> - Aggiunta da Catalogo (Linea 2175) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/user-movies/add"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">add_movie_to_collection</span><span class="token punctuation">(</span>movie<span class="token punctuation">:</span> AddMovieRequest<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Verifica se esiste gi√†</span>
    existing <span class="token operator">=</span> movies_collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-if">if</span> existing<span class="token punctuation">:</span>
        <span class="token comment"># AGGIORNAMENTO: usa UPDATE_RATING se cambia il rating</span>
        <span class="token keyword keyword-if">if</span> old_rating <span class="token operator">!=</span> new_rating<span class="token punctuation">:</span>
            kafka_producer<span class="token punctuation">.</span>send_movie_event<span class="token punctuation">(</span><span class="token string">"UPDATE_RATING"</span><span class="token punctuation">,</span> current_user_id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
                <span class="token string">"old_rating"</span><span class="token punctuation">:</span> old_rating<span class="token punctuation">,</span>
                <span class="token string">"new_rating"</span><span class="token punctuation">:</span> new_rating
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        <span class="token comment"># NUOVO: usa ADD</span>
        movies_collection<span class="token punctuation">.</span>insert_one<span class="token punctuation">(</span>new_movie<span class="token punctuation">)</span>
        kafka_producer<span class="token punctuation">.</span>send_movie_event<span class="token punctuation">(</span><span class="token string">"ADD"</span><span class="token punctuation">,</span> current_user_id<span class="token punctuation">,</span> new_movie<span class="token punctuation">)</span>
</code></pre><blockquote>
<p>[!TIP]<br>
La differenziazione tra <code>ADD</code> e <code>UPDATE_RATING</code> √® fondamentale per evitare duplicazioni. Se un film esiste gi√† e cambia solo il rating, NON dobbiamo incrementare <code>total_watched</code>.</p>
</blockquote>
<h3 id="43-post-user-moviesremove---rimozione-film-linea-2316">4.3 POST <code>/user-movies/remove</code> - Rimozione Film (Linea 2316) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/user-movies/remove"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">remove_movie_from_collection</span><span class="token punctuation">(</span>movie<span class="token punctuation">:</span> RemoveMovieRequest<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Recupera dati COMPLETI PRIMA di eliminare</span>
    existing_movie <span class="token operator">=</span> movies_collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. Elimina</span>
    movies_collection<span class="token punctuation">.</span>delete_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"_id"</span><span class="token punctuation">:</span> existing_movie<span class="token punctuation">[</span><span class="token string">"_id"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3. Pubblica DELETE con tutti i dati necessari</span>
    kafka_producer<span class="token punctuation">.</span>send_movie_event<span class="token punctuation">(</span><span class="token string">"DELETE"</span><span class="token punctuation">,</span> current_user_id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">"name"</span><span class="token punctuation">:</span> existing_movie<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"year"</span><span class="token punctuation">:</span> existing_movie<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"year"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"rating"</span><span class="token punctuation">:</span> existing_movie<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"rating"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Necessario per rating_distribution</span>
        <span class="token string">"date"</span><span class="token punctuation">:</span> existing_movie<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">)</span>       <span class="token comment"># Necessario per monthly_counts</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><blockquote>
<p>[!WARNING]<br>
√à ESSENZIALE recuperare i dati del film <strong>PRIMA</strong> di eliminarlo. Senza <code>rating</code> e <code>date</code>, Spark non potrebbe decrementare i contatori corretti.</p>
</blockquote>
<h3 id="44-put-user-moviesupdate-rating---aggiornamento-rating-linea-2361">4.4 PUT <code>/user-movies/update-rating</code> - Aggiornamento Rating (Linea 2361) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>put</span><span class="token punctuation">(</span><span class="token string">"/user-movies/update-rating"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">update_movie_rating</span><span class="token punctuation">(</span>movie<span class="token punctuation">:</span> UpdateMovieRequest<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Recupera film esistente per old_rating</span>
    existing <span class="token operator">=</span> movies_collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    old_rating <span class="token operator">=</span> existing<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"rating"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. Aggiorna in MongoDB</span>
    movies_collection<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3. Pubblica UPDATE_RATING con delta</span>
    kafka_producer<span class="token punctuation">.</span>send_movie_event<span class="token punctuation">(</span><span class="token string">"UPDATE_RATING"</span><span class="token punctuation">,</span> current_user_id<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">"old_rating"</span><span class="token punctuation">:</span> old_rating<span class="token punctuation">,</span>
        <span class="token string">"new_rating"</span><span class="token punctuation">:</span> new_rating
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p><strong>Cosa fa Spark con UPDATE_RATING:</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># Spark (pseudocodice)</span>
rating_distribution<span class="token punctuation">[</span>old_rating<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">1</span>
rating_distribution<span class="token punctuation">[</span>new_rating<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
sum_ratings <span class="token operator">+=</span> <span class="token punctuation">(</span>new_rating <span class="token operator">-</span> old_rating<span class="token punctuation">)</span>
<span class="token comment"># total_watched rimane invariato!</span>
</code></pre><h3 id="45-post-upload-csv---caricamento-bulk-linea-1087">4.5 POST <code>/upload-csv</code> - Caricamento Bulk (Linea 1087) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/upload-csv"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">upload_csv</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Parsing CSV</span>
    df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>contents<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. Salva film (replace totale)</span>
    movies_collection<span class="token punctuation">.</span>delete_many<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> current_user_id<span class="token punctuation">}</span><span class="token punctuation">)</span>
    movies_collection<span class="token punctuation">.</span>insert_many<span class="token punctuation">(</span>movies<span class="token punctuation">)</span>
    
    <span class="token comment"># 3. RESET STATISTICHE (CRITICO!)</span>
    stats_collection<span class="token punctuation">.</span>delete_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> current_user_id<span class="token punctuation">}</span><span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>user_affinities<span class="token punctuation">.</span>delete_many<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> current_user_id<span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 4. Pubblica BULK_IMPORT</span>
    kafka_producer<span class="token punctuation">.</span>send_batch_event<span class="token punctuation">(</span><span class="token string">"BULK_IMPORT"</span><span class="token punctuation">,</span> current_user_id<span class="token punctuation">,</span> movies<span class="token punctuation">)</span>
</code></pre><blockquote>
<p>[!CAUTION]<br>
Il <strong>RESET delle statistiche</strong> prima del BULK_IMPORT √® OBBLIGATORIO. Spark usa operazioni <code>$inc</code> (incrementali) quindi senza reset si avrebbero conteggi doppi.</p>
</blockquote>
<h3 id="46-post-recalculate-stats---ricalcolo-manuale-linea-1230">4.6 POST <code>/recalculate-stats</code> - Ricalcolo Manuale (Linea 1230) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/recalculate-stats"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">recalculate_stats</span><span class="token punctuation">(</span>current_user_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    movies <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>movies_collection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> current_user_id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># RESET STATISTICHE</span>
    stats_collection<span class="token punctuation">.</span>delete_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> current_user_id<span class="token punctuation">}</span><span class="token punctuation">)</span>
    db<span class="token punctuation">.</span>user_affinities<span class="token punctuation">.</span>delete_many<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> current_user_id<span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># Pubblica RECALCULATE</span>
    kafka_producer<span class="token punctuation">.</span>send_batch_event<span class="token punctuation">(</span><span class="token string">"RECALCULATE"</span><span class="token punctuation">,</span> current_user_id<span class="token punctuation">,</span> movies<span class="token punctuation">)</span>
</code></pre><hr>
<h2 id="5Ô∏è‚É£-lettura-statistiche-laltro-lato-del-flusso">5Ô∏è‚É£ Lettura Statistiche: L'Altro Lato del Flusso </h2>
<h3 id="get-user-stats-linea-1290">GET <code>/user-stats</code> (Linea 1290) </h3>
<p>Questo endpoint legge le statistiche CALCOLATE da Spark e le formatta per il frontend.</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/user-stats"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_user_stats</span><span class="token punctuation">(</span>current_user_id<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Depends<span class="token punctuation">(</span>get_current_user_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 1. Leggi da user_stats (scritto da Spark)</span>
    stats <span class="token operator">=</span> stats_collection<span class="token punctuation">.</span>find_one<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> current_user_id<span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. Sync real-time del conteggio (fonte di verit√†: movies collection)</span>
    total_watched <span class="token operator">=</span> movies_collection<span class="token punctuation">.</span>count_documents<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> current_user_id<span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 3. Leggi directors/actors/genres da user_affinities</span>
    affinities_collection <span class="token operator">=</span> db<span class="token punctuation">.</span>user_affinities
    directors_cursor <span class="token operator">=</span> affinities_collection<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"user_id"</span><span class="token punctuation">:</span> current_user_id<span class="token punctuation">,</span> 
        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"director"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
</code></pre><h3 id="schema-delle-statistiche-v6">Schema delle Statistiche (V6) </h3>
<pre data-role="codeBlock" data-info="javascript" class="language-javascript javascript"><code><span class="token comment">// Collection: user_stats</span>
<span class="token punctuation">{</span>
    <span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token string">"pasquale.langellotti"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"total_watched"</span><span class="token operator">:</span> <span class="token number">847</span><span class="token punctuation">,</span>           <span class="token comment">// Calcolato da Spark</span>
    <span class="token string-property property">"sum_ratings"</span><span class="token operator">:</span> <span class="token number">3245</span><span class="token punctuation">,</span>            <span class="token comment">// Somma di tutti i rating</span>
    <span class="token string-property property">"watch_time_minutes"</span><span class="token operator">:</span> <span class="token number">102450</span><span class="token punctuation">,</span>   <span class="token comment">// Minuti totali</span>
    <span class="token string-property property">"rating_distribution"</span><span class="token operator">:</span> <span class="token punctuation">{</span>        <span class="token comment">// Distribuzione rating</span>
        <span class="token string-property property">"1"</span><span class="token operator">:</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string-property property">"2"</span><span class="token operator">:</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token string-property property">"3"</span><span class="token operator">:</span> <span class="token number">156</span><span class="token punctuation">,</span> <span class="token string-property property">"4"</span><span class="token operator">:</span> <span class="token number">312</span><span class="token punctuation">,</span> <span class="token string-property property">"5"</span><span class="token operator">:</span> <span class="token number">311</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"monthly_counts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>             <span class="token comment">// Film per mese/anno</span>
        <span class="token string-property property">"2024"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"01"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token string-property property">"02"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token spread operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string-property property">"2025"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token string-property property">"01"</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token spread operator">...</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"genre_counts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>               <span class="token comment">// Film per genere</span>
        <span class="token string-property property">"Drama"</span><span class="token operator">:</span> <span class="token number">234</span><span class="token punctuation">,</span> <span class="token string-property property">"Comedy"</span><span class="token operator">:</span> <span class="token number">178</span><span class="token punctuation">,</span> <span class="token spread operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"stats_version"</span><span class="token operator">:</span> <span class="token string">"6.0_flat_affinities"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"updated_at"</span><span class="token operator">:</span> <span class="token string">"2026-01-22T12:00:00+01:00"</span>
<span class="token punctuation">}</span>

<span class="token comment">// Collection: user_affinities (struttura piatta V6)</span>
<span class="token punctuation">{</span>
    <span class="token string-property property">"user_id"</span><span class="token operator">:</span> <span class="token string">"pasquale.langellotti"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"director"</span><span class="token punctuation">,</span>             <span class="token comment">// o "actor" o "genre"</span>
    <span class="token string-property property">"name_key"</span><span class="token operator">:</span> <span class="token string">"Christopher_Nolan"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"Christopher Nolan"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"count"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>                     <span class="token comment">// Film visti</span>
    <span class="token string-property property">"sum_voti"</span><span class="token operator">:</span> <span class="token number">38</span>                  <span class="token comment">// Somma rating</span>
<span class="token punctuation">}</span>
</code></pre><hr>
<h2 id="6Ô∏è‚É£-altri-endpoint-importanti">6Ô∏è‚É£ Altri Endpoint Importanti </h2>
<h3 id="cinema-endpoints-linee-610-1030">Cinema Endpoints (Linee 610-1030) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/cinema/films"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_cinema_films</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Ottiene film in programmazione arricchiti col catalogo</span>
    <span class="token comment"># Filtra film gi√† visti dall'utente</span>
</code></pre><h3 id="recommendations-linea-1625">Recommendations (Linea 1625) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/recommendations"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_recommendations</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-from">from</span> recommendation_service <span class="token keyword keyword-import">import</span> get_recommendation_service
    service <span class="token operator">=</span> get_recommendation_service<span class="token punctuation">(</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> run_in_threadpool<span class="token punctuation">(</span>service<span class="token punctuation">.</span>get_recommendations<span class="token punctuation">,</span> current_user_id<span class="token punctuation">)</span>
</code></pre><h3 id="quiz-ai-linee-2860-3051">Quiz AI (Linee 2860-3051) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token string">"/quiz/questions"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">get_quiz_questions</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Restituisce domande generate da Ollama</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/quiz/submit"</span><span class="token punctuation">)</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">submit_quiz_results</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Salva risultati e aggiorna statistiche quiz</span>
</code></pre><hr>
<h2 id="7Ô∏è‚É£-diagramma-completo-dellarchitettura">7Ô∏è‚É£ Diagramma Completo dell'Architettura </h2>
<div class="mermaid">graph TB
    subgraph Client
        FE[Frontend React]
    end
    
    subgraph Backend
        API[FastAPI App]
        AUTH[Auth Module]
        KP[Kafka Producer]
    end
    
    subgraph Database
        MONGO[(MongoDB)]
        ES[(Elasticsearch)]
    end
    
    subgraph MessageBroker
        KAFKA[Apache Kafka]
    end
    
    subgraph Processing
        SPARK[Spark Streaming]
    end
    
    subgraph External
        TMDB[TMDB API]
        OLLAMA[Ollama LLM]
    end
    
    FE &lt;--&gt;|HTTP| API
    API --&gt; AUTH
    API --&gt; KP
    API &lt;--&gt; MONGO
    API &lt;--&gt; ES
    API --&gt; TMDB
    API --&gt; OLLAMA
    KP --&gt; KAFKA
    KAFKA --&gt; SPARK
    SPARK --&gt; MONGO
</div><hr>
<h2 id="8Ô∏è‚É£-riepilogo-del-flusso-kafka">8Ô∏è‚É£ Riepilogo del Flusso Kafka </h2>
<div class="mermaid">sequenceDiagram
    participant U as Utente
    participant F as Frontend
    participant B as Backend (main.py)
    participant M as MongoDB
    participant K as Kafka
    participant S as Spark
    
    U-&gt;&gt;F: Aggiunge film "Inception"
    F-&gt;&gt;B: POST /user-movies/add
    B-&gt;&gt;M: insert_one({name: "Inception", rating: 5})
    B-&gt;&gt;K: send_movie_event("ADD", user_id, movie_data)
    B-&gt;&gt;F: {"status": "success"}
    
    Note over K,S: Elaborazione asincrona
    
    K-&gt;&gt;S: Evento ADD
    S-&gt;&gt;S: Calcola delta statistiche
    S-&gt;&gt;M: $inc {total_watched: 1, rating_distribution.5: 1, ...}
    
    Note over U,F: 30 secondi dopo...
    
    U-&gt;&gt;F: Apre Dashboard
    F-&gt;&gt;B: GET /user-stats
    B-&gt;&gt;M: find_one({user_id})
    M-&gt;&gt;B: {total_watched: 848, avg_rating: 3.84, ...}
    B-&gt;&gt;F: Statistiche formattate
    F-&gt;&gt;U: Mostra dashboard aggiornata
</div><hr>
<h2 id="9Ô∏è‚É£-punti-chiave-da-ricordare">9Ô∏è‚É£ Punti Chiave da Ricordare </h2>
<blockquote>
<p>[!IMPORTANT]<br>
<strong>Regola d'Oro #1</strong>: Ogni operazione che modifica i film dell'utente DEVE pubblicare un evento Kafka.</p>
</blockquote>
<blockquote>
<p>[!IMPORTANT]<br>
<strong>Regola d'Oro #2</strong>: Prima di BULK_IMPORT o RECALCULATE, SEMPRE resettare <code>user_stats</code> e <code>user_affinities</code>.</p>
</blockquote>
<blockquote>
<p>[!IMPORTANT]<br>
<strong>Regola d'Oro #3</strong>: Per DELETE, recuperare i dati del film PRIMA di eliminarlo.</p>
</blockquote>
<blockquote>
<p>[!IMPORTANT]<br>
<strong>Regola d'Oro #4</strong>: Usare UPDATE_RATING solo quando cambia il rating, non ADD (evita duplicazioni).</p>
</blockquote>
<hr>
<h2 id="-file-correlati">üîó File Correlati </h2>
<table>
<thead>
<tr>
<th>File</th>
<th>Descrizione</th>
</tr>
</thead>
<tbody>
<tr>
<td>[kafka_producer.py](file:///c:/Users/lange/Desktop/Esame-Fenza/backend/kafka_producer.py)</td>
<td>Producer Kafka con singleton pattern</td>
</tr>
<tr>
<td>[spark_stats_processor.py](file:///c:/Users/lange/Desktop/Esame-Fenza/backend/spark_stats_processor.py)</td>
<td>Consumer Spark che elabora gli eventi</td>
</tr>
<tr>
<td>[<a href="http://auth.py">auth.py</a>](file:///c:/Users/lange/Desktop/Esame-Fenza/backend/auth.py)</td>
<td>Gestione autenticazione JWT</td>
</tr>
<tr>
<td>[recommendation_service.py](file:///c:/Users/lange/Desktop/Esame-Fenza/backend/recommendation_service.py)</td>
<td>Sistema raccomandazioni con FAISS</td>
</tr>
<tr>
<td>[quiz_generator.py](file:///c:/Users/lange/Desktop/Esame-Fenza/backend/quiz_generator.py)</td>
<td>Generazione quiz con Ollama</td>
</tr>
<tr>
<td>[cinema_pipeline.py](file:///c:/Users/lange/Desktop/Esame-Fenza/backend/cinema_pipeline.py)</td>
<td>Scraping programmazione cinema</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="-dettaglio-del-processore-spark-spark_stats_processorpy">üî• Dettaglio del Processore Spark (<code>spark_stats_processor.py</code>) </h2>
<p>Questa sezione spiega in profondit√† come Spark elabora gli eventi ricevuti da Kafka.</p>
<h3 id="architettura-v6-flat-affinities">Architettura V6: Flat Affinities </h3>
<p>L'architettura attuale (versione 6.0) separa le metriche in due collezioni:</p>
<div class="mermaid">graph LR
    subgraph "Spark Worker"
        PI[process_partition_incremental]
        CATALOG[Batch Catalog Lookup]
        AGG[Aggregazione In-Memoria]
    end
    
    subgraph "MongoDB"
        US[(user_stats&lt;br/&gt;Metriche globali)]
        UA[(user_affinities&lt;br/&gt;Struttura piatta)]
        GS[(global_stats&lt;br/&gt;Community trends)]
    end
    
    PI --&gt; CATALOG
    CATALOG --&gt; AGG
    AGG --&gt;|bulk_write #1| US
    AGG --&gt;|bulk_write #2| UA
    PI --&gt;|streaming separato| GS
</div><h3 id="perch√©-struttura-piatta">Perch√© Struttura Piatta? </h3>
<table>
<thead>
<tr>
<th>Aspetto</th>
<th>V5 (Nidificata)</th>
<th>V6 (Piatta)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Documento user_stats</strong></td>
<td>100KB+ (con tutti directors/actors)</td>
<td>~5KB (solo metriche)</td>
</tr>
<tr>
<td><strong>Query per "migliori registi"</strong></td>
<td>Aggregation Pipeline complessa</td>
<td><code>find({type: "director"}).sort({count: -1})</code></td>
</tr>
<tr>
<td><strong>Tempo di write</strong></td>
<td>500ms+ per documento grande</td>
<td>10-50ms per bulk piccolo</td>
</tr>
<tr>
<td><strong>Scalabilit√†</strong></td>
<td>Limite 16MB per documento</td>
<td>Illimitata</td>
</tr>
</tbody>
</table>
<h3 id="la-funzione-process_partition_incremental">La Funzione <code>process_partition_incremental</code> </h3>
<p>Questa √® la funzione core che viene eseguita <strong>in parallelo</strong> su ogni worker Spark:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">process_partition_incremental</span><span class="token punctuation">(</span>iterator<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Eseguita in parallelo su ogni partizione Spark.
    Ogni partizione contiene eventi di N utenti.
    """</span>
    
    <span class="token comment"># 1. BATCH LOOKUP CATALOGO</span>
    <span class="token comment"># Invece di fare N query (una per film), facciamo UNA query con $in</span>
    all_titles <span class="token operator">=</span> <span class="token punctuation">{</span>event<span class="token punctuation">.</span>name <span class="token keyword keyword-for">for</span> event <span class="token keyword keyword-in">in</span> all_events<span class="token punctuation">}</span>
    catalog_docs <span class="token operator">=</span> db<span class="token punctuation">.</span>movies_catalog<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"$or"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$in"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>all_titles<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token string">"normalized_title"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$in"</span><span class="token punctuation">:</span> normalized_titles<span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    catalog_map <span class="token operator">=</span> <span class="token punctuation">{</span>d<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span><span class="token punctuation">:</span> d <span class="token keyword keyword-for">for</span> d <span class="token keyword keyword-in">in</span> catalog_docs<span class="token punctuation">}</span>
    
    <span class="token comment"># 2. AGGREGAZIONE IN-MEMORIA</span>
    <span class="token comment"># Accumula tutti gli incrementi prima di scrivere</span>
    user_stats_inc <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>       <span class="token comment"># {user_id: {field: delta}}</span>
    user_affinities_inc <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># {affinity_id: {count, sum_voti}}</span>
    
    <span class="token keyword keyword-for">for</span> event <span class="token keyword keyword-in">in</span> events<span class="token punctuation">:</span>
        delta <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword keyword-if">if</span> <span class="token string">"DELETE"</span> <span class="token keyword keyword-in">in</span> event<span class="token punctuation">.</span>event_type <span class="token keyword keyword-else">else</span> <span class="token number">1</span>
        
        <span class="token comment"># Accumula per user_stats</span>
        user_stats_inc<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"total_watched"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> delta
        user_stats_inc<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"sum_ratings"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> rating <span class="token operator">*</span> delta
        user_stats_inc<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"monthly_counts.</span><span class="token interpolation"><span class="token punctuation">{</span>year<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>month<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">]</span> <span class="token operator">+=</span> delta
        
        <span class="token comment"># Accumula per user_affinities (directors, actors, genres)</span>
        <span class="token keyword keyword-for">for</span> director <span class="token keyword keyword-in">in</span> directors_list<span class="token punctuation">:</span>
            affinity_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>user_id<span class="token punctuation">}</span></span><span class="token string">_director_</span><span class="token interpolation"><span class="token punctuation">{</span>director_key<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            user_affinities_inc<span class="token punctuation">[</span>affinity_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"count"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> delta
            user_affinities_inc<span class="token punctuation">[</span>affinity_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"sum_voti"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> rating <span class="token operator">*</span> delta
    
    <span class="token comment"># 3. BULK WRITE (una operazione per collezione)</span>
    db<span class="token punctuation">.</span>user_stats<span class="token punctuation">.</span>bulk_write<span class="token punctuation">(</span><span class="token punctuation">[</span>
        UpdateOne<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"user_id"</span><span class="token punctuation">:</span> uid<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"$inc"</span><span class="token punctuation">:</span> increments<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> uid<span class="token punctuation">,</span> increments <span class="token keyword keyword-in">in</span> user_stats_inc<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    db<span class="token punctuation">.</span>user_affinities<span class="token punctuation">.</span>bulk_write<span class="token punctuation">(</span><span class="token punctuation">[</span>
        UpdateOne<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"_id"</span><span class="token punctuation">:</span> aid<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"$inc"</span><span class="token punctuation">:</span> data<span class="token punctuation">,</span> <span class="token string">"$set"</span><span class="token punctuation">:</span> metadata<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> aid<span class="token punctuation">,</span> data <span class="token keyword keyword-in">in</span> user_affinities_inc<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><h3 id="gestione-update_rating">Gestione UPDATE_RATING </h3>
<p>Quando un utente cambia solo il rating di un film esistente:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-if">if</span> is_update_rating<span class="token punctuation">:</span>
    old_rating <span class="token operator">=</span> event<span class="token punctuation">.</span>old_rating
    new_rating <span class="token operator">=</span> event<span class="token punctuation">.</span>new_rating
    
    stats_inc <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token comment"># Sposta da distribuzione vecchia a nuova</span>
        <span class="token string-interpolation"><span class="token string">f"rating_distribution.</span><span class="token interpolation"><span class="token punctuation">{</span>old_rating<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token string-interpolation"><span class="token string">f"rating_distribution.</span><span class="token interpolation"><span class="token punctuation">{</span>new_rating<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">:</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>
        
        <span class="token comment"># Aggiorna somma (delta)</span>
        <span class="token string">"sum_ratings"</span><span class="token punctuation">:</span> new_rating <span class="token operator">-</span> old_rating
    <span class="token punctuation">}</span>
    
    <span class="token comment"># NOTA: total_watched NON viene toccato!</span>
    <span class="token comment"># NOTA: monthly_counts NON viene toccato!</span>
    
    <span class="token comment"># Per affinities: aggiorna solo sum_voti</span>
    <span class="token keyword keyword-for">for</span> affinity <span class="token keyword keyword-in">in</span> related_affinities<span class="token punctuation">:</span>
        affinity<span class="token punctuation">[</span><span class="token string">"sum_voti"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token punctuation">(</span>new_rating <span class="token operator">-</span> old_rating<span class="token punctuation">)</span>
        <span class="token comment"># count resta invariato</span>
</code></pre><h3 id="flusso-temporale-completo">Flusso Temporale Completo </h3>
<div class="mermaid">sequenceDiagram
    participant U as Utente
    participant B as Backend
    participant K as Kafka
    participant S as Spark
    participant M as MongoDB
    
    Note over S: All'avvio
    S-&gt;&gt;M: bootstrap_global_stats()
    S-&gt;&gt;M: Legge ultimi 30 giorni di film
    S-&gt;&gt;M: Inizializza global_stats
    
    Note over S: Streaming attivo
    
    U-&gt;&gt;B: Aggiunge "Inception"
    B-&gt;&gt;M: insert_one()
    B-&gt;&gt;K: send_movie_event("ADD")
    B-&gt;&gt;U: ‚úì Film aggiunto
    
    Note over K,S: ~1 secondo
    
    K-&gt;&gt;S: Batch di eventi
    S-&gt;&gt;S: process_batch()
    S-&gt;&gt;S: Raggruppa per user_id
    S-&gt;&gt;S: foreachPartition(process_partition)
    
    Note over S,M: Su ogni worker
    
    S-&gt;&gt;M: Bulk lookup catalogo
    M-&gt;&gt;S: director, genres, duration
    S-&gt;&gt;S: Calcola incrementi
    S-&gt;&gt;M: bulk_write(user_stats)
    S-&gt;&gt;M: bulk_write(user_affinities)
    
    Note over U,B: ~10-30 secondi dopo
    
    U-&gt;&gt;B: GET /user-stats
    B-&gt;&gt;M: find_one(user_stats)
    B-&gt;&gt;M: find(user_affinities)
    M-&gt;&gt;B: Dati aggiornati
    B-&gt;&gt;U: Dashboard con nuovo film
</div><h3 id="due-stream-paralleli-in-spark">Due Stream Paralleli in Spark </h3>
<p>Spark esegue <strong>due stream contemporaneamente</strong>:</p>
<table>
<thead>
<tr>
<th>Stream</th>
<th>Funzione</th>
<th>Trigger</th>
<th>Collezione Target</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>User Stats</strong></td>
<td><code>process_batch()</code></td>
<td>Ogni 5 secondi</td>
<td><code>user_stats</code> + <code>user_affinities</code></td>
</tr>
<tr>
<td><strong>Global Trends</strong></td>
<td><code>write_global_trends_to_mongo()</code></td>
<td>Ogni 2 minuti</td>
<td><code>global_stats</code></td>
</tr>
</tbody>
</table>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># stream 1: statistiche utente</span>
user_stats_query <span class="token operator">=</span> parsed_stream<span class="token punctuation">.</span>writeStream \
    <span class="token punctuation">.</span>foreachBatch<span class="token punctuation">(</span>process_batch<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>trigger<span class="token punctuation">(</span>processingTime<span class="token operator">=</span><span class="token string">"5 seconds"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># stream 2: trend globali community</span>
global_trends_query <span class="token operator">=</span> aggregated \
    <span class="token punctuation">.</span>writeStream \
    <span class="token punctuation">.</span>foreachBatch<span class="token punctuation">(</span>write_global_trends_to_mongo<span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>trigger<span class="token punctuation">(</span>processingTime<span class="token operator">=</span><span class="token string">"2 minutes"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><h3 id="bootstrap-allavvio">Bootstrap all'Avvio </h3>
<p>Prima di iniziare lo streaming, Spark esegue un <strong>bootstrap</strong> per inizializzare <code>global_stats</code>:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">bootstrap_global_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Legge TUTTI i film degli ultimi 30 giorni da MongoDB
    e inizializza i contatori base per global_stats.
    Lo streaming poi aggiorner√† in modo incrementale.
    """</span>
    
    <span class="token comment"># 1. Leggi film recenti</span>
    recent_movies <span class="token operator">=</span> db<span class="token punctuation">.</span>movies<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"date"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"$gte"</span><span class="token punctuation">:</span> thirty_days_ago<span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 2. Conta film e generi</span>
    movie_counts <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    genre_counts <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword keyword-for">for</span> movie <span class="token keyword keyword-in">in</span> recent_movies<span class="token punctuation">:</span>
        movie_counts<span class="token punctuation">[</span>movie<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
        <span class="token keyword keyword-for">for</span> genre <span class="token keyword keyword-in">in</span> movie<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"genres"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            genre_counts<span class="token punctuation">[</span>genre<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
    
    <span class="token comment"># 3. Salva stato iniziale</span>
    db<span class="token punctuation">.</span>global_stats<span class="token punctuation">.</span>update_one<span class="token punctuation">(</span>
        <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"global_trends"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"$set"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"top_movies"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>top <span class="token number">10</span> pi√π visti<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"trending_genres"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>top <span class="token number">10</span> generi<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"movie_counts"</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>movie_counts<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Per merge streaming</span>
            <span class="token string">"genre_counts"</span><span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>genre_counts<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"bootstrap"</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        upsert<span class="token operator">=</span><span class="token boolean">True</span>
    <span class="token punctuation">)</span>
</code></pre><hr>
<h2 id="-riepilogo-collezioni-mongodb">üìä Riepilogo Collezioni MongoDB </h2>
<table>
<thead>
<tr>
<th>Collezione</th>
<th>Scritta da</th>
<th>Letta da</th>
<th>Scopo</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>movies</code></td>
<td>Backend</td>
<td>Backend, Spark</td>
<td>Film visti dall'utente</td>
</tr>
<tr>
<td><code>movies_catalog</code></td>
<td>Backend (TMDB)</td>
<td>Backend, Spark</td>
<td>Metadati film (poster, cast, ecc.)</td>
</tr>
<tr>
<td><code>user_stats</code></td>
<td>Spark</td>
<td>Backend</td>
<td>Statistiche aggregate utente</td>
</tr>
<tr>
<td><code>user_affinities</code></td>
<td>Spark</td>
<td>Backend</td>
<td>Conteggi per director/actor/genre</td>
</tr>
<tr>
<td><code>global_stats</code></td>
<td>Spark</td>
<td>Backend</td>
<td>Trend community (top film, generi)</td>
</tr>
<tr>
<td><code>users</code></td>
<td>Backend</td>
<td>Backend</td>
<td>Account utente</td>
</tr>
</tbody>
</table>

      </div>
      
      
    
    
    <script type="module">
// TODO: If ZenUML gets integrated into mermaid in the future,
//      we can remove the following lines.


var MERMAID_CONFIG = ({"startOnLoad":false});
if (typeof MERMAID_CONFIG !== 'undefined') {
  MERMAID_CONFIG.startOnLoad = false
  MERMAID_CONFIG.cloneCssStyles = false
  MERMAID_CONFIG.theme = "default"
}

mermaid.initialize(MERMAID_CONFIG || {})
if (typeof(window['Reveal']) !== 'undefined') {
  function mermaidRevealHelper(event) {
    var currentSlide = event.currentSlide
    var diagrams = currentSlide.querySelectorAll('.mermaid')
    for (var i = 0; i < diagrams.length; i++) {
      var diagram = diagrams[i]
      if (!diagram.hasAttribute('data-processed')) {
        mermaid.init(null, diagram, ()=> {
          Reveal.slide(event.indexh, event.indexv)
        })
      }
    }
  }
  Reveal.addEventListener('slidetransitionend', mermaidRevealHelper)
  Reveal.addEventListener('ready', mermaidRevealHelper)
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
} else {
  await mermaid.run({
    nodes: document.querySelectorAll('.mermaid')
  })
}
</script>
    
    
    
  
    </body></html>